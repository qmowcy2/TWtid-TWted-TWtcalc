/***
|editable|k
|''Name:''|TWted|
|''Description:''|In-place edit table cells|
|''Author:''|Vincent Yeh (qmo.wcy2@gmail.com)|
|''Source:''|* (minimized) http://twtable.tiddlyspace.com/#TWted.min <br>* (regular) http://twtable.tiddlyspace.com/#TWted |
|''Type:''|plugin|
|''Version:''|1.6.2|
|''Status:''|This plugin is still under development.<br>You are welcome to try and send feedback. :-)|
|''Date:''|2012/10/19 released 1.4.0<br>2012/09/04 started from TableEditor 1.3.0|
|''License:''|Same as TiddlyWiki.|
|''Core Version:''|2.6.5.|
|''Needs to have:''|TWtable|

!!Options
Click the {{{C}}} button for related options.
***/

// @@display:none;
//{{{
version.extensions.TWted={major:1,minor:6,revision:2,date:new Date("2013/04/19")};config.macros.noedit={handler:function(a){addClass(a,"noedit")}};
config.macros.TWted={init:function(){void 0===config.options.chkTWtedEnabled&&(config.options.chkTWtedEnabled=!0);void 0===config.options.chkTWtedInViewMode&&(config.options.chkTWtedInViewMode=!0);void 0===config.options.chkTWtedNoClick&&(config.options.chkTWtedNoClick=!1);void 0===config.options.chkTWtedPreview&&(config.options.chkTWtedPreview=!0);void 0===config.options.txtTWtedPreviewOpacity&&(config.options.txtTWtedPreviewOpacity="1.00");void 0===config.options.txtTWtedPreviewCaret?config.options.txtTWtedPreviewCaret=
"|":/^[0-9]+$/.test(config.options.txtTWtedPreviewCaret)&&(config.options.txtTWtedPreviewCaret=String.fromCharCode(1*config.options.txtTWtedPreviewCaret));void 0===config.options.chkTWtedDisableLink&&(config.options.chkTWtedDisableLink=!1);void 0===config.options.chkTWtedConfirmToDelete&&(config.options.chkTWtedConfirmToDelete=void 0===config.options.chkTEditorConfirmToDelete?!0:config.options.chkTEditorConfirmToDelete);void 0===config.options.chkTWtedClickAway&&(config.options.chkTWtedClickAway=
void 0===config.options.chkTEditorClickAway?!0:config.options.chkTEditorClickAway);void 0===config.options.chkTWtedManualSave&&(config.options.chkTWtedManualSave=void 0===config.options.chkTEditorManualSave?!1:config.options.chkTEditorManualSave);void 0===config.options.chkTWtedManualUpload&&(config.options.chkTWtedManualUpload=void 0===config.options.chkTEditorManualUpload?!1:config.options.chkTEditorManualUpload);void 0===config.options.chkTWtedEditAllTables&&(config.options.chkTWtedEditAllTables=
void 0===config.options.chkTEditorAllTableEditable?!1:config.options.chkTEditorAllTableEditable);void 0===config.options.chkTWtedIncludeSubs&&(config.options.chkTWtedIncludeSubs=!1);void 0===config.options.chkTWtedIncludeCSS&&(config.options.chkTWtedIncludeCSS=void 0===config.options.chkTEditorIncludeCSS?!0:config.options.chkTEditorIncludeCSS);merge(config.optionsDesc,{chkTWtedEnabled:"Enable ~TWted.",chkTWtedInViewMode:"Active in view mode. Otherwise in edit mode.",chkTWtedNoClick:"Edit the cell content without clicking it.",
chkTWtedPreview:"Enable previewer. Default to true.",txtTWtedPreviewOpacity:"Opacity of the previewer. Default to 0.9.",txtTWtedPreviewCaret:"Caret in the previewer. Default to vertical line (|)",chkTWtedDisableLink:"Disable links in edit mode.",chkTWtedConfirmToDelete:"Confirm before deleting table rows/columns.",chkTWtedClickAway:"Click away to accept changes.",chkTWtedManualSave:'Save changes to file manually. If true, a button labeled "S" will be provided for manual save. Otherwise the file will be saved each time a change is accepted.',
chkTWtedManualUpload:'Upload changes to server manually. If true, a button labeled "U" will be provided for manual upload. Otherwise all changes will be uploaded each time a change is accepted.',chkTWtedEditAllTables:'Edit all tables. If true, all tables are editable. Otherwise only tables with class name "editable" are editable.',chkTWtedIncludeSubs:"Include sub-elements to edit. For example, sub lists are included in the editbox if this option is set to true.",chkTWtedIncludeCSS:"Include cell-wide CSS statements in the edit box."});
TWted.pre_closeAllTiddlers=story.closeAllTiddlers;story.closeAllTiddlers=TWted.closeAllTiddlers;TWted.pre_refreshTiddler=story.refreshTiddler;story.refreshTiddler=TWted.refreshTiddler;TWted.pre_OfficialExample=TWtid.OfficialExample;TWtid.OfficialExample=TWted.OfficialExample;TWted.pre_prepare_table=TWtid.prepare_table;TWtid.prepare_table=TWted.prepare_table;TWted.pre_save_text=TWtid.save_text;TWtid.save_text=TWted.save_text;TWted.pre_start_sorting=TWtid.start_sorting;TWtid.start_sorting=TWted.start_sorting;
TWted.pre_table_scrolled=TWtid.table_scrolled;TWtid.table_scrolled=TWted.table_scrolled;TWted.pre_fix_rows_adjust=TWtid.fix_rows_adjust;TWtid.fix_rows_adjust=TWted.fix_rows_adjust;TWted.pre_fix_cols_adjust=TWtid.fix_cols_adjust;TWtid.fix_cols_adjust=TWted.fix_cols_adjust;TWted.pre_resize=TWtid.resize;TWtid.resize=TWted.resize;TWted.pre_inactive_elem=TWtid.inactive_elem;TWtid.inactive_elem=TWted.inactive_elem;TWted.pre_is_button=TWtid.is_button;TWtid.is_button=TWted.is_button;TWted.pre_hide_buttons=
TWtid.hide_buttons;TWtid.hide_buttons=TWted.hide_buttons;TWted.pre_focus=TWtid.focus;TWtid.focus=TWted.focus;TWted.pre_slider_close=TWtid.slider_close;TWtid.slider_close=TWted.slider_close;TWted.pre_header_click=TWtid.header_click;TWtid.header_click=TWted.header_click;TWted.pre_refresh_wrapper=TWtid.refresh_wrapper;TWtid.refresh_wrapper=TWted.refresh_wrapper;TWted.pre_edit_handler=config.commands.editTiddler.handler;config.commands.editTiddler.handler=TWted.edit_handler;TWted.pre_close_handler=config.commands.closeTiddler.handler;
config.commands.closeTiddler.handler=TWted.close_handler;TWted.pre_save_handler=config.commands.saveTiddler.handler;config.commands.saveTiddler.handler=TWted.save_handler;TWted.pre_cancel_handler=config.commands.cancelTiddler.handler;config.commands.cancelTiddler.handler=TWted.cancel_handler;TWted.pre_saveChanges=saveChanges;saveChanges=TWted.saveChanges;var a=config.shadowTiddlers.OptionsPanel,b=a.indexOf("TWtidOptions");0<=b?config.shadowTiddlers.OptionsPanel=a.substring(0,b)+"TWtedOptions\n"+a.substring(b):
(b=a.indexOf("----"),config.shadowTiddlers.OptionsPanel=a.substring(0,b)+"----\nTWtedOptions\n"+a.substring(b));merge(config.shadowTiddlers,{TWtedOptions:"<<TWtedOptions>>"})}};
config.macros.TWtedOptions={order:{chkTWtedEnabled:0,chkTWtedInViewMode:1,chkTWtedNoClick:2,chkTWtedPreview:3,txtTWtedPreviewOpacity:4,txtTWtedPreviewCaret:5,chkTWtedDisableLink:6,chkTWtedConfirmToDelete:7,chkTWtedClickAway:8,chkTWtedManualSave:9,chkTWtedManualUpload:10,chkTWtedEditAllTables:11,chkTWtedIncludeSubs:12,chkTWtedIncludeCSS:13},options_changed:function(a,b){0<a.size()?TWted.replaced_ta&&(config.options.chkTWtedInViewMode||!config.options.chkTWtidEnabled||!config.options.chkTWtedEnabled)?
(b=TWtid.wrapper_tiddler(a),TWted.replaced_ta.val(b.tiddler.text),a.replaceWith(TWted.replaced_ta),TWted.replaced_ta=null):TWted.pre_options_changed.apply(this,arguments):!config.options.chkTWtedInViewMode&&(config.options.chkTWtidEnabled&&config.options.chkTWtedEnabled)&&TWted.replace_editor(b.title,b)},handler:function(a){config.macros.TWtidOptions.show_options_table(a,"TWted Options","TWted",this.order)}};
TWted={cur_title:null,cur_ndx:null,saved_index:function(a){return this.cur_ndx?this.cur_ndx.dIndex==a.dIndex:!1},pre_start_sorting:null,start_sorting:function(a,b,c){return TWted.pre_start_sorting.apply(this,arguments)?TWted.cur_title!=c.title&&!TWted.saved_index(b):!1},ins_del_row:function(a,b,c){var d=a.parent(),e=TWted.$cur_block,a=TWtid.wrapper_tiddler(e),f=a.tiddler.text.split("\n"),e=TWtid.element_index(e,a),d=1*d.attr("row"),e=TWtid.table_first_line(f,e,a.title),g=TWtid.table_last_line(f,e),
h=TWtid.line_number_of_table_row(f,e,d);if(b){for(var j="|",k=TWtid.split_table_row(f[h>g?g:h]).length-2,c=0;c<k;c++)j+="|";"below"==b&&(d++,h++);f.splice(h,0,j);h<=TWted.copied_rndx&&TWted.copied_rndx++;TWtid.table_changed("ROW INSERTED",{text:f,first:e,last:g+1,where:d},a)}else{if(!1!==c&&config.options.chkTWtedConfirmToDelete&&!confirm("Delete row "+d))return-1;if(h<g){b=TWtid.split_table_row(f[h]);j=TWtid.split_table_row(f[h+1]);k=!1;for(c=1;c<b.length-1;c++)"~"==j[c]&&"~"!=b[c]&&(j[c]=b[c],k=
!0);k&&(f[h+1]=TWtid.make_table_row(j))}f.splice(h,1);h<TWted.copied_rndx&&TWted.copied_rndx--;TWtid.table_changed("ROW DELETED",{text:f,first:e,last:g-1,where:d},a)}TWtid.save_text(a.tiddler,f);TWtid.refresh_wrapper(a,!0);return d},insertRow:function(a,b){return this.ins_del_row(a,b)},deleteRow:function(a,b){return this.ins_del_row(a,null,b)},copied_rndx:-1,copied_row:null,copy_paste_row:function(a,b){var c=a.parent(),d=TWted.$cur_block,e=TWtid.wrapper_tiddler(d),f=e.tiddler.text.split("\n"),d=TWtid.element_index(d,
e),c=1*c.attr("row"),d=TWtid.table_first_line(f,d,e.title),c=TWtid.line_number_of_table_row(f,d,c);"copy"===b?(this.copied_rndx=c,this.copied_row=f[c]):(f[c]=this.copied_row,TWtid.table_changed("ROW PASTED",{text:f,from:TWted.copied_rndx,to:c},e),TWtid.save_text(e.tiddler,f),TWtid.refresh_wrapper(e,!0))},copyRow:function(a){this.copy_paste_row(a,"copy");this.copied_cndx=-1;this.copied_column=null},pasteRow:function(a){-1!=this.copied_rndx&&this.copy_paste_row(a,"paste")},ins_del_col:function(a,b,
c){var d=a.parent(),e=TWted.$cur_block,a=TWtid.wrapper_tiddler(e),f=a.tiddler.text.split("\n"),e=TWtid.element_index(e,a),d=1*d.attr("col"),e=TWtid.table_first_line(f,e,a.title),g=TWtid.table_last_line(f,e);if(b){"right"==b&&d++;for(c=e;c<=g;c++)/[kKcC]$/.test(f[c])||(b=TWtid.split_table_row(f[c]),b.splice(d+1,0,""),f[c]=TWtid.make_table_row(b));d<=TWted.copied_cndx&&TWted.copied_cndx++;TWtid.table_changed("COL INSERTED",{text:f,first:e,last:g,where:d},a)}else{if(!1!==c&&config.options.chkTWtedConfirmToDelete&&
!confirm("Delete column "+TWtid.col_ref(d)))return-1;for(c=e;c<=g;c++)/[kKcC]$/.test(f[c])||(b=TWtid.split_table_row(f[c]),0<d&&(">"==b[d]&&">"!=b[d+1])&&(b[d]=b[d+1]),b.splice(d+1,1),f[c]=TWtid.make_table_row(b));d<TWted.copied_cndx&&TWted.copied_cndx--;TWtid.table_changed("COL DELETED",{text:f,first:e,last:g,where:d},a)}TWtid.save_text(a.tiddler,f);TWtid.refresh_wrapper(a,!0);return d},insertColumn:function(a,b){return this.ins_del_col(a,b)},deleteColumn:function(a,b){return this.ins_del_col(a,
null,b)},copied_cndx:-1,copied_column:null,copy_paste_column:function(a,b){var c=a.parent(),d=TWted.$cur_block,e=TWtid.wrapper_tiddler(d),f=e.tiddler.text.split("\n"),d=TWtid.element_index(d,e),c=1*c.attr("col"),d=TWtid.table_first_line(f,d,e.title),g=TWtid.table_last_line(f,d),h,j="copy"===b,k=0;j&&(this.copied_column=[]);for(var i=d;i<=g;i++)/[kKcC]$/.test(f[i])||(h=TWtid.split_table_row(f[i]),j?this.copied_column.push(h[c+1]):(h[c+1]=this.copied_column[k++],f[i]=TWtid.make_table_row(h)));j?this.copied_cndx=
c:(TWtid.table_changed("COL PASTED",{text:f,first:d,last:g,from:TWted.copied_cndx,to:c},e),TWtid.save_text(e.tiddler,f),TWtid.refresh_wrapper(e,!0))},copyColumn:function(a){this.copy_paste_column(a,"copy");this.copied_rndx=-1;this.copied_row=null},pasteColumn:function(a){this.copied_column&&this.copy_paste_column(a,"paste")},wikify_elem:function(a,b,c){var d=TWtid.elem_wide_style_text(b);d&&(b=b.substring(d.length));if(!c){var c=/^[ ]/.test(b),e=/[ ]$/.test(b);switch(a[0].nodeName){case "LI":break;
default:c?e?a.css("text-align","center"):a.css("text-align","right"):e?a.css("text-align","left"):a.css("text-align","inherit")}b=b.trim()}switch(a[0].nodeName){case "TH":case "TD":/^[\!]/.test(b)?("TH"!=a[0].nodeName&&($newcell=jQuery(createTiddlyElement(null,"th")),a.replaceWith($newcell),$newcell.css("text-align",a.css("text-align")),a=$newcell),b=b.substring(1)):"TD"!=a[0].nodeName&&($newcell=jQuery(createTiddlyElement(null,"td")),a.replaceWith($newcell),$newcell.css("text-align",a.css("text-align")),
a=$newcell);default:if(d=d?d.match(/[\w-]+[:]{1}[\w-]+[;]{1}/g):null){c=[];for(e=0;e<d.length;e++){var f=d[e].match(/[\w-]+/g);c.push({style:f[0],value:f[1]})}config.formatterHelpers.applyCssHelper(a[0],c)}a.empty();wikify(b,a[0])}"undefined"!==typeof MathJax&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,a[0]])},pre_refresh_wrapper:null,refresh_wrapper:function(a,b){TWted.pre_refresh_wrapper.apply(this,arguments);b&&(TWted.$cur_block=null)},update_list_item_text:function(a,b,c){a||(a=TWtid.wrapper_tiddler(b));
for(var d=TWtid.element_index(b,a),e=a.tiddler.text.split("\n"),d=TWtid.list_item_line(e,d,a.title),f=config.options.chkTWtedIncludeSubs?TWtid.list_last_line(e,d+1,TWtid.list_prefix(e[d])):d,g=0,h=e[d].charAt(0),j=0,k=c.charAt(0);e[d].charAt(g)==h;)g++;TWtid.lines_of_text(e,d,f,c);TWtid.save_text(a.tiddler,e);if(c){for(;c.charAt(j)==k;)j++;j==g&&h==k?/\n/.test(c)?TWtid.refresh_wrapper(a,!0):(TWted.wikify_elem(b,c.substring(j)),TWted.sub_elem&&TWted.sub_elem.appendTo(b)):TWtid.refresh_wrapper(a,!0)}else if(TWted.sub_elem)if(c=
TWtid.list_prefix(g),c.prefix.test(e[d-1]))a=b.prev(),TWted.sub_elem.appendTo(a),b.remove(),TWted.$cur_block=a;else{c=TWtid.list_prefix(g+1);for(b=d;c.prefix.test(e[b]);)e[b]=e[b].substring(1),b++;TWtid.save_text(a.tiddler,e);TWtid.refresh_wrapper(a,!0)}else b.remove(),TWtid.cur_block(null),TWted.$cur_block=null;TWted.sub_elem=null;return!0},update_header_text:function(a,b,c){a||(a=TWtid.wrapper_tiddler(b));var d=TWtid.element_index(b,a),e=a.tiddler.text.split("\n"),d=TWtid.header_first_line(e,d,
a.title);if(c)if(e[d]=c,b.is(".foldable"))TWtid.save_text(a.tiddler,e),TWtid.refresh_wrapper(a,!0);else{for(var d=1*b[0].nodeName.charAt(1),f=0;"!"==c.charAt(f);)f++;c=c.substring(f);TWtid.save_text(a.tiddler,e);f!=d&&(a=jQuery("<H"+f+"></H"+f+">"),b.replaceWith(a),a.attr("rIndex",b.attr("rIndex")),a.attr("dIndex",b.attr("dIndex")),b=a);for(a=0;" "==c.charAt(a);)a++;0<a&&(c=c.substring(a));TWted.wikify_elem(b,c)}else e.splice(d,1),TWtid.save_text(a.tiddler,e),TWtid.refresh_wrapper(a,!0);return!0},
update_section_text:function(a,b,c){var d=a.tiddler.text.split("\n"),e=TWtid.header_first_line(d,b,a.title),b=TWtid.header_first_line(d,{rIndex:-1,dIndex:b.dIndex+1},a.title);-1==b&&(b=d.length);TWtid.lines_of_text(d,e+1,b,c);TWtid.save_text(a.tiddler,d)},update_header_content_text:function(a,b,c){var d=b.prev(),a=TWtid.wrapper_tiddler(d),d=TWtid.element_index(d,a);this.update_section_text(a,d,c);TWted.wikify_elem(b,c);return!0},update_blockquote_text:function(a,b,c){a||(a=TWtid.wrapper_tiddler(b));
var b=TWted.locatable_elem(b),d=TWtid.element_index(b,a),b=a.tiddler.text.split("\n"),d=TWtid.blockquote_first_line(b,d,a.title),e;TWtid.blockexample_first_line(b[d])?(e=TWtid.blockexample_last_line(b,d+1),TWtid.lines_of_text(b,d,e,c)):c?(e=TWtid.blockquote_last_line(b,d),TWtid.lines_of_text(b,d,e,c)):b.splice(d,1);TWtid.save_text(a.tiddler,b);TWtid.refresh_wrapper(a,!0);TWted.sub_elem=null;return!0},preformat_skip_opening:function(a){var b=3;switch(a.charAt(0)){default:return 3;case "/":for(;"{"!=
a.charAt(b);)b++;for(;"{"==a.charAt(b);)b++;if("*"==a.charAt(1))for(;"/"!=a.charAt(b);)b++;return b+1;case "<":for(;"{"!=a.charAt(b);)b++;for(;"{"==a.charAt(b);)b++;for(;">"!=a.charAt(b);)b++;return b+1}},preformat_skip_closing:function(a){var b=a.length-3;switch(a.charAt(0)){default:return b;case "/":for(;"}"!=a.charAt(b);)b--;for(;"}"==a.charAt(b);)b--;for(;"/"!=a.charAt(b);)b--;return"/"==a.charAt(b-1)?b-1:b;case "<":for(;"}"!=a.charAt(b);)b--;for(;"}"==a.charAt(b);)b--;for(;"<"!=a.charAt(b);)b--;
return b}},update_preformat_text:function(a,b,c){a||(a=TWtid.wrapper_tiddler(b));var d=TWtid.element_index(b,a),e=a.tiddler.text.split("\n"),d=TWtid.preformat_first_line(e,d,a.title),f=TWtid.preformat_last_line(e,d);TWtid.lines_of_text(e,d,f,c);TWtid.save_text(a.tiddler,e);a=this.preformat_skip_opening(c);e=this.preformat_skip_closing(c);b.text(c.substring(a,e).trim());return!0},plain_text_starts:function(a,b,c,d,e,f){var g,h=0;jQuery.contains(a[0],b[0])?(g=TWtid.element_index(b,c),h=TWted.block_elem_first_line(b,
d,g,c.title),h=TWted.block_elem_last_line(b,d,h)+1):f&&(g.rIndex=-1,g.dIndex=0,h=TWted.block_elem_first_line("H1",d,g,e)+1);return h},plain_text_ends:function(a,b,c,d,e,f){var g=d.length-1,h;jQuery.contains(a[0],b[0])?(h=TWtid.element_index(b,c),g=TWted.block_elem_first_line(b,d,h,c.title)-1):f&&(h.rIndex=-1,h.dIndex=0,g=TWted.block_elem_first_line("H1",d,h,e,r0)-1);return g},update_between:function(a,b,c){var d=jQuery(b[2]),a=TWtid.wrapper_tiddler(d),e=a.tiddler.text.split("\n"),f=jQuery(b[0]),b=
jQuery(b[1]),g=TWtid.tiddler_title(a.title),h=TWtid.tiddler_section(a.title),f=TWted.plain_text_starts(d,f,a,e,g,h),d=TWted.plain_text_ends(d,b,a,e,g,h);TWtid.lines_of_text(e,f,d,c);TWtid.save_text(a.tiddler,e);TWtid.refresh_wrapper(a,!0);return!0},update_cell_text:function(a,b,c){var d=a.tiddler.text.split("\n"),e=TWtid.table_element(b),f=TWtid.element_index(e,a),g=TWtid.table_first_line(d,f,a.title),h=TWtid.table_last_line(d,g),j,k,i=TWtid.cell_row_index(b),m=b[0].cellIndex,l=b.attr("rowspan"),
n=b.attr("colspan"),s=0;j=TWtid.line_number_of_table_row(d,g,i);for(var l=void 0===l?1:1*l,n=void 0===n?1:1*n,p=0;p<l;p++,j++){var o=TWtid.split_table_row(d[j]),t;if(0==p&&-1==(k=TWtid.cell_index_in_line(o,m)))k=o.length-1,o.push("");for(var q=n-1;0<=q;q--,s++)t=config.options.chkTWtidMultiLine?c[s].replace(/\n/mg," <br>"):c[s],o[k-q]=config.options.chkTWtedIncludeCSS||"~"==o[k-q]||">"==o[k-q]?t:TWtid.elem_wide_style_text(o[k-q])+t;d[j]=TWtid.make_table_row(o)}1<l||1<n||"~"==c[0]||">"==c[0]?(TWtid.save_text(a.tiddler,
d),TWtid.refresh_wrapper(a,!0)):(c=c[0],a.$wrapper.each(function(l,p){if(e=TWtid.table_element(TWtid.find_tables(jQuery(p)),f,a,l))b=e.find("tr").eq(i).find("th,td").eq(m),TWted.wikify_elem(b,c),TWtid.table_changed("MODIFIED",{table:e,row:i,col:m,text:d,first:g,last:h,rndx:j,cndx:k},a)}),TWtid.save_text(a.tiddler,d));return!0},update_caption_text:function(a,b,c){var d=a.tiddler.text.split("\n"),b=TWtid.table_element(b),b=TWtid.element_index(b,a),b=TWtid.table_first_line(d,b,a.title),e=TWtid.table_last_line(d,
b),f=0,g=!1;for(r=b;r<=e;r++)if(/[cC]$/.test(d[r])){f=1;break}r>e&&(r=b+(/[kK]$/.test(d[b])?1:0));c?(d.splice(r,f,"|"+c+"|c"),g=!0):0<f&&(d.splice(r,f),g=!0);return g?(TWtid.save_text(a.tiddler,d),TWtid.refresh_wrapper(a,!0),!0):!1},update_tiddler_text:function(a,b,c){if(1<b.size())return TWted.update_between(a,b,c[0]),!0;switch(b[0].nodeName){case "TD":case "TH":return this.update_cell_text(a,b,c);case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":return this.update_header_text(a,b,c[0]);
case "SPAN":if(b.is(".sliderPanel"))return this.update_header_content_text(a,b,c[0]);break;case "BLOCKQUOTE":return this.update_blockquote_text(a,b,c[0]);case "LI":return this.update_list_item_text(a,b,c[0]);case "PRE":return this.update_preformat_text(a,b,c[0]);case "DIV":if(TWtid.is_wrapper(b))return TWtid.tiddler_section(a.title)?TWted.update_section_text(a,{rIndex:-1,dIndex:0},c[0]):TWtid.save_text(a.tiddler,c[0]),TWtid.refresh_wrapper(a,!0),!0;if(b.is("[id^=tedTC]"))return this.update_caption_text(a,
b,c[0]);if(b.is(".title")&&c[0])return TWtid.save_text(a.tiddler,null,c[0]),!0}return!1},pre_save_text:null,save_text:function(a,b){var c=TWted.pre_save_text.apply(this,arguments);"file:"==window.location.protocol?config.options.chkTWtedManualSave||autoSaveChanges(null,[a]):!config.options.chkTWtedManualUpload&&config.macros.upload&&config.macros.upload.action();return c},pre_resize:null,resize:function(a){TWted.$cur_elem||TWted.pre_resize.apply(this,arguments)},detach_contents:function(a,b){return/\[[\<\>]?img/.test(b)?
null:a.contents().detach()},multi_line:function(a,b){switch(a[0].nodeName){case "DIV":case "P":return!0;case "SPAN":if(TWtid.is_wrapper(a))return!0;default:return config.options.chkTWtidMultiLine||/\n/.test(b)}},$cur_elem:null,$edit_box:null,$preview:null,edit_element:function(a,b,c){TWted.$cur_elem=a;var d=a.size(),e=3>d?a:jQuery(a[2]),f=TWtid.css_size(e.css("font-size")),g=a.width(),h=a.css("text-align");a.css("font-family");var j=f*config.options.txtTWtidMinCellWidth,k=TWtid.css_size(a.css("line-height"));
g<j&&(g=j);!b&&1==d&&(b=a.text());var i;"string"==typeof b?(i=[jQuery("<textarea>"+b+"</textarea>")],i[0][0].defaultValue=b,i[0].width(g)):(i=b,b=i[0].val(),">"==b&&(b=jQuery(i[0].get(-1)).val()));var m=a.closest("div[id=tiddlerDisplay]"),l=TWtid.element_box(a);l.height<k&&(l.height=k);jQuery.each(i,function(c,e){TWted.$edit_box=c==0?jQuery(e):TWted.$edit_box.add(e);i.length==1&&e.appendTo(m).css({position:"absolute",left:l.left,top:l.top,width:l.width,height:l.height});e.css({padding:"0",margin:"0",
overflow:"auto","text-align":h,"font-family":"monospace","font-size":f}).attr({scrH0:l.height,spellcheck:"true",cancel:"false",title:"("+(TWted.multi_line(a,b)?"Ctrl-":"")+"ENTER=accept, ESC=cancel)"}).keydown(TWted.keydown).bind("paste",TWted.paste).bind("copy",function(a){TWted.copy_and_cut(a,TWted.$cur_elem)}).bind("cut",function(a){TWted.copy_and_cut(a,TWted.$cur_elem,true)});switch(a[0].nodeName){case "LI":case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":if(d==1){e.height(0);var g=
e.prop("scrollHeight");if(g<l.height)g=l.height;e.height(g);a.attr("elemH",a.height())}}});i[0].select().focus();if(!c){TWted.$preview||(TWted.$preview=jQuery("<span></span>").appendTo(m).css({position:"absolute","z-index":1,border:"1px solid black",padding:0,margin:0,"background-color":"#fff8dc",opacity:config.options.txtTWtedPreviewOpacity}).addClass("preview"));var n=TWtid.element_offset(i[0]);TWted.$preview.css({left:n.left,top:n.top,width:i[0].width()});TWtid.copy_font_text(TWted.$preview,e);
setTimeout(function(){TWted.preview_editbox(i[0],null,n)},0)}TWtid.hide_buttons();return i},edit_caption:function(a,b,c,d){b||(b=TWtid.table_element(a));d||(d=TWtid.wrapper_tiddler(a));c||(c=TWtid.element_index(b,d));if(TWted.cur_title==d.title&&TWted.saved_index(c)){for(var b=d.tiddler.text.split("\n"),e=TWtid.table_first_line(b,c,d.title),c=TWtid.table_last_line(b,e),d=" ";e<=c;e++)if(/[cC]$/.test(b[e])){d=TWtid.split_table_row(b[e])[1];break}this.edit_element(a,d)}},edit_neighbor_cell:function(a,
b,c){var d=TWtid.table_element(a),e=TWtid.cell_row_index(a),a=a[0].cellIndex;switch(b){case "left":a-=c?c:1;break;case "right":a+=c?c:1;break;case "up":e-=c?c:1;break;case "down":e+=c?c:1}TWted.focusout();var c=d.find("tr"),f=(b=d.attr("oversize"))?1*config.options.txtTWtidFixRows:0;e<f?e=c.size()-1:e>=c.size()&&(e=f);e=c.eq(e).find("th,td");b=b?1*config.options.txtTWtidFixCols:0;a<b?a=e.size()-1:a>=e.size()&&(a=b);TWted.edit_cell(e.eq(a),d)},edit_neighbor:function(a,b,c){var d=a[0].nodeName;if("TH"==
d||"TD"==d)TWted.edit_neighbor_cell(a,b,c);else{var c=TWtid.wrapper_tiddler(a),d=TWtid.direct_wrapper(a,c),e=TWtid.element_index(a,c);switch(b){case "left":case "up":e.rIndex--;e.dIndex--;break;case "right":case "down":e.rIndex++,e.dIndex++}var f=b=null;switch(a[0].nodeName){case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":b=TWtid.find_headers(d);f=TWted.edit_header;break;case "LI":b=TWtid.find_list_items(d);f=TWted.edit_list_item;break;case "PRE":b=TWtid.find_elements(d,"PRE");f=TWted.edit_preformat;
break;case "BLOCKQUOTE":b=TWtid.find_elements(d,"BLOCKQUOTE"),f=TWted.edit_blockquote}b&&0<b.size()&&(0>e.rIndex?(e.rIndex=b.size()-1,e.dIndex=-1):e.rIndex>=b.size()&&(e.rIndex=0,e.dIndex=-1),a=jQuery(b.get(e.rIndex)),TWted.focusout(),f.call(this,a,c,e))}},edit_cell:function(a,b,c,d){if(a.is(".noedit"))return!1;var e=b&&c&&d;b||(b=TWtid.table_element(a));var f=TWtid.cell_row_index(a);if(0==f&&b[0].tHead&&TWtid.sorting_enabled())return displayMessage("sort or edit?"),!1;d||(d=TWtid.wrapper_tiddler(b));
c||(c=TWtid.element_index(b,d));if(e||TWted.cur_title==d.title&&TWted.saved_index(c)){var e=d.tiddler.text.split("\n"),d=TWtid.table_first_line(e,c,d.title),g=a[0].cellIndex,c=a.attr("rowspan"),h=a.attr("colspan"),j,k,c=void 0===c?1:1*c,h=void 0===h?1:1*h;j=TWtid.cell_wiki_ndx(e,d,f,g,c,h);k=j.text;config.options.chkTWtedIncludeCSS||(k[0][h-1]=TWtid.remove_style_text(k[0][h-1]));config.options.chkTWtidMultiLine&&(k[0][h-1]=k[0][h-1].replace(/ <br>/mg,"\n").replace(/<br>/mg,"\n").replace(/ <br \/>/mg,
"\n").replace(/<br \/>/mg,"\n"));e=b.parent();d=e.scrollTop();g=e.scrollLeft();if(1==c&&1==h)this.edit_element(a,k[0][0]);else{var i=[],m,l,n,s=b.parent().parent().find("[id^=tedTrefH]").find("span"),p=b.find("tr"),o=TWtid.css_size(a.css("line-height")),t=a.closest("#displayArea");jQuery.each(k,function(a,b){i[a]=[];l=p.eq(f+a);var c=TWtid.element_offset(l),d=l.innerHeight();d<o&&(d=o);jQuery.each(b,function(b,e){n=s.eq(j.cndx-h+b);m=jQuery("<textarea>"+e+"</textarea>");1<k.length&&m.appendTo(t).css({position:"absolute",
left:TWtid.element_offset(n).left,top:c.top,width:n.innerWidth(),height:d});m[0].defaultValue=e;i[a][b]=m[0]});i[a]=jQuery([]).pushStack(i[a])});this.edit_element(a,i)}e.scrollTop(d).scrollLeft(g);b.resize()}return!0},locatable_elem:function(a){for(var b,c,d=a[0].nodeName;;){b=a.parent(d);if(0==b.size())return a;c=b.children().not(d);if(0<c.size())return a;a=b}},sub_elem:null,edit_list_item:function(a,b,c){b||(b=TWtid.wrapper_tiddler(a));c||(c=TWtid.element_index(a,b));var d=b.tiddler.text.split("\n"),
b=TWtid.list_item_line(d,c,b.title);config.options.chkTWtedIncludeSubs?(c=TWtid.list_prefix(d[b]),c=TWtid.list_last_line(d,b+1,c),this.edit_element(a,TWtid.lines_of_text(d,b,c)),TWted.sub_elem=null):(TWted.sub_elem=a.children("ol,ul"),this.edit_element(a,d[b]),0<TWted.sub_elem.size()?TWted.sub_elem.appendTo(a):TWted.sub_elem=null)},edit_header:function(a,b,c){b||(b=TWtid.wrapper_tiddler(a));c||(c=TWtid.element_index(a,b));var d=b.tiddler.text.split("\n"),b=TWtid.header_first_line(d,c,b.title);this.edit_element(a,
d[b])},edit_header_content:function(a){this.edit_element(a,TWtid.header_content(a.prev()))},edit_blockquote:function(a,b,c){b||(b=TWtid.wrapper_tiddler(a));var d=TWted.locatable_elem(a);c||(c=TWtid.element_index(d,b));d=b.tiddler.text.split("\n");b=TWtid.blockquote_first_line(d,c,b.title);TWtid.blockexample_first_line(d[b])?(c=TWtid.blockexample_last_line(d,b+1),d=TWtid.lines_of_text(d,b,c),this.edit_element(a,d)):(c=TWtid.blockquote_last_line(d,b),d=TWtid.lines_of_text(d,b,c),TWted.sub_elem=a.children("blockquote"),
0<a.children().not("blockquote").size()?(this.edit_element(a,d),0<TWted.sub_elem.size()?TWted.sub_elem.appendTo(a):TWted.sub_elem=null):(this.edit_element(TWted.sub_elem,d),TWted.sub_elem=null))},edit_preformat:function(a,b,c){b||(b=TWtid.wrapper_tiddler(a));c||(c=TWtid.element_index(a,b));var d=b.tiddler.text.split("\n"),b=TWtid.preformat_first_line(d,c,b.title),c=TWtid.preformat_last_line(d,b);this.edit_element(a,TWtid.lines_of_text(d,b,c))},edit_span:function(a){if(a.is(".sliderPanel"))return this.edit_header_content(a),
!0;var b=a.attr("tiddler");if(!b)return!1;switch(b){case "SiteTitle":case "SiteSubtitle":return!1;default:return(b=TWtid.closest_blocks(a,ev))?TWted.edit_between(b):TWted.edit_tiddler(a),!0}},block_elem_first_line:function(a,b,c,d,e){switch("string"==typeof a?a:a[0].nodeName){case "PRE":return TWtid.preformat_first_line(b,c,d);case "TABLE":return TWtid.table_first_line(b,c,d);case "BLOCKQUOTE":return TWtid.blockquote_first_line(b,c,d);case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":return TWtid.header_first_line(b,
c,d,e);case "LI":return TWtid.list_item_line(b,c,d)}a=TWtid.wrapper_info(a);return a.macro?TWtid.macro_first_line(b,c,d,a.macro):0},block_elem_last_line:function(a,b,c){switch(a[0].nodeName){case "PRE":return TWtid.preformat_last_line(b,c);case "TABLE":return TWtid.table_last_line(b,c);case "BLOCKQUOTE":return TWtid.blockquote_last_line(b,c);case "LI":case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":return c}return TWtid.wrapper_info(a).macro?TWtid.macro_last_line(b,c):0},edit_between:function(a){var b=
jQuery(a[2]),c=TWtid.wrapper_tiddler(b),d=c.tiddler.text.split("\n"),e=jQuery(a[0]),f=jQuery(a[1]),g=TWtid.tiddler_title(c.title),h=TWtid.tiddler_section(c.title),e=TWted.plain_text_starts(b,e,c,d,g,h),b=TWted.plain_text_ends(b,f,c,d,g,h);TWted.edit_element(a,TWtid.lines_of_text(d,e,b))},edit_div:function(a,b){var c;if(TWtid.is_wrapper(a))return(c=TWtid.closest_blocks(a,b))?TWted.edit_between(c):TWted.edit_tiddler(a),!0;if(a.is(".title"))return TWted.edit_tiddler_title(a),!0},edit_tiddler_title:function(a,
b){b||(b=TWtid.wrapper_tiddler(a));return!TWted.replaced_ta&&!story.getTiddlerField(b.title,"text")?(this.edit_element(a,b.tiddler.title),!0):!1},edit_tiddler:function(a,b){b||(b=TWtid.wrapper_tiddler(a));var c=TWtid.tiddler_section(b.title)?store.getTiddlerText(b.title):b.tiddler.text;this.edit_element(a,c)},edit_parent:function(a,b){var c=a.closest("h1,h2,h3,h4,h5,h6");if(1==c.size())return this.edit_header(c),!0;c=a.closest("li");if(1==c.size())return this.edit_list_item(c),!0;if(!a.is("[id^=tedTbtn]")&&
(c=a.closest("div[id^=tedTC]"),1==c.size()))return this.edit_caption(c),!0;c=a.closest("blockquote");if(1==c.size())return this.edit_blockquote(c),!0;c=a.closest("div");if(1==c.size()&&this.edit_div(c,b))return!0;c=a.closest("span");return 1==c.size()&&this.edit_span(c)?!0:!1},edit_ev:null,editInPlace:function(a,b){if(readOnly||!config.options.chkTWtidEnabled||!config.options.chkTWtedEnabled||!config.options.chkTWtedInViewMode&&!TWted.replaced_ta||"TEXTAREA"==a[0].nodeName||"A"==a[0].nodeName&&!config.options.chkTWtedDisableLink||
b&&(b.ctrlKey||b.shiftKey||b.altKey))return!1;if(TWted.$cur_elem){if(TWted.$cur_elem[0]==a[0])return!0;config.options.chkTWtedClickAway&&this.focusout()}var c=null;TWted.edit_ev=b;switch(a[0].nodeName){case "TD":case "TH":return this.edit_cell(a);case "TABLE":var d=null,c=a;c.find("tr").each(function(a,c){d=jQuery(c);var e=TWtid.element_offset(d),f=jQuery(window),f=b.clientY+f.scrollTop();if(f>=e.top&&f<=e.top+d.height())return!1});a=d;case "TR":c||(c=a.closest("table"));var e=TWtid.wrapper_tiddler(c),
f=TWtid.element_index(c,e);return TWted.cur_title==e.title&&TWted.saved_index(f)?this.edit_cell(jQuery("<td></td>").attr("missed",!0).appendTo(a),c,f,e):!1}c=a.closest("th,td");if(1==c.size())return this.edit_cell(c);TWted.$cur_block&&(TWted.$cur_block.is("TABLE")&&TWted.$cur_block[0]!=TWtid.cur_block()[0])&&TWted.toggleEditMode(TWted.$cur_block,"stop");switch(a[0].nodeName){case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":if(!a.is(".foldable")||config.options.chkTWtedNoClick)return this.edit_header(a),
!0;break;case "BLOCKQUOTE":return this.edit_blockquote(a),!0;case "LI":return this.edit_list_item(a),!0;case "SPAN":return!TWted.edit_span(a)?this.edit_parent(a,b):!0;case "PRE":return this.edit_preformat(a),!0;case "DIV":if(TWted.edit_div(a,b))return!0;default:return this.edit_parent(a,b)}},move_element:function(a,b){switch(a[0].nodeName){case "LI":if(0==a.closest("th,td").size()){var c=TWtid.wrapper_tiddler(a),d=TWtid.element_index(a,c),e=c.tiddler.text.split("\n"),f=TWtid.list_item_line(e,d,c.title),
g=e[f];e.splice(f,1);e.splice(f+b,0,g);TWtid.save_text(c.tiddler,e);d={rIndex:d.rIndex+b,dIndex:d.dIndex+b};e=jQuery(TWtid.find_list_items(c.$wrapper).get(d.rIndex));TWted.focusout();f=e.html();e.html(a.html());a.html(f);TWted.edit_list_item(e,c,d);return!0}}return!1},adjust_tables:function(a){TWtid.find_tables(a).each(function(a,c){var d=jQuery(c);TWtid.fix_cols_adjust(d).fix_rows_adjust(d)})},focusout:function(){var a=TWted.$cur_elem;if(a){var b=TWted.$edit_box,c=!1,d=!1,e=!1,f=[],g;b.each(function(a,
b){var d=jQuery(b);g=d.val();f.push(g);"true"==d.attr("cancel")&&(c=!0);b.defaultValue!=g&&(e=!0)});!c&&e&&(d=TWtid.wrapper_tiddler(jQuery(a[0])),d=TWted.update_tiddler_text(d,a,f));d||(a.attr("missed")?a.remove():1<a.size()?TWted.adjust_tables(TWtid.direct_wrapper(a)):TWtid.is_wrapper(a)&&TWted.adjust_tables(TWtid.direct_wrapper(a)));a.attr({elemH:"",missed:""});b.remove();(a=TWtid.table_element(a))&&a.resize();TWted.$cur_elem=TWted.edit_ev=null;TWted.close_editbox()}},caret_position:function(a,
b){if(b)if(a[0].setSelectionRange)a.focus(),a[0].setSelectionRange(b,b);else{if(a[0].createTextRange){var c=a[0].createTextRange();c.collapse(!0);c.moveEnd("character",b);c.moveStart("character",b);c.select()}}else{try{if(document.selection){a[0].focus();var c=document.selection.createRange(),d=c.duplicate();d.moveToElementText(a[0]);d.setEndPoint("EndToStart",c);return d.text.length-c.text.length}if(a[0].selectionStart||"0"==a[0].selectionStart)return 1*a[0].selectionStart}catch(e){}return-1}},get_selection:function(a){var b=
a.jquery?a[0]:a,a={start:0,end:0};if("number"==typeof b.selectionStart&&"number"==typeof b.selectionEnd)a.start=b.selectionStart,a.end=b.selectionEnd;else if(document.selection){var c=document.selection.createRange().getBookmark(),b=b.createTextRange(),d=b.duplicate();b.moveToBookmark(c);d.setEndPoint("EndToStart",b);a.start=d.text.length;a.end=a.start+b.text.length}return a},close_editbox:function(){TWted.$preview.hide();TWted.$edit_box.hide();TWted.$edit_box=null},preview_editbox:function(a,b,c){if(config.options.chkTWtedPreview){if("number"!=
typeof b||-1==b)b=TWted.caret_position(a);var d=a.val(),d=0==b?config.options.txtTWtedPreviewCaret+d:d.substring(0,b)+config.options.txtTWtedPreviewCaret+d.substring(b);TWted.wikify_elem(TWted.$preview,d);c||(c=TWtid.element_offset(a));c.top-=TWted.$preview.outerHeight();TWted.$preview.css({top:c.top}).show()}else TWted.$preview.hide()},keydown:function(a){var a=a||window.event,b=jQuery(this),c=TWted.$cur_elem;switch(a.which){case 13:if(TWted.multi_line(c,b.val())){if(a.ctrlKey)return TWted.focusout(),
!1}else return a.ctrlKey||TWted.focusout(),!1;default:var d=this;setTimeout(function(){TWted.keydown_after.call(d,a,b,c)},0)}},last_caret_pos:-100,keydown_after:function(a,b,c){var d=TWted.$edit_box,e=0,f=-1,e=c.attr("colspan"),g=c.attr("rowspan"),e=e?1*e:1,g=g?1*g:1;switch(a.which){case 27:return d.attr("cancel","true"),TWted.focusout(),!1;case 37:if(a.shiftKey)break;f=TWted.caret_position(b);0==f&&TWted.last_caret_pos==f?1<e?(e=d.index(b),0==e?TWted.edit_neighbor(c,"left"):(b=d.eq(--e),b.focus(),
TWted.preview_editbox(b))):TWted.edit_neighbor(c,"left"):TWted.preview_editbox(b,f);TWted.last_caret_pos=f;break;case 38:if(a.shiftKey)break;if(a.ctrlKey)return TWted.move_element(c,-1),!1;f=TWted.caret_position(b);0==f&&f==TWted.last_caret_pos?1<g?(e=d.index(b),0==e?TWted.edit_neighbor(c,"up"):(b=d.eq(--e),b.focus(),TWted.preview_editbox(b))):TWted.edit_neighbor(c,"up"):TWted.preview_editbox(b);TWted.last_caret_pos=f;break;case 39:if(a.shiftKey)break;f=TWted.caret_position(b);f==b.val().length&&
TWted.last_caret_pos==f?1<e?(e=d.index(b),e==d.size()-1?TWted.edit_neighbor(c,"right"):(b=d.eq(++e),b.focus(),TWted.preview_editbox(b))):TWted.edit_neighbor(c,"right"):TWted.preview_editbox(b,f);TWted.last_caret_pos=f;break;case 40:if(a.shiftKey)break;if(a.ctrlKey)return TWted.move_element(c,1),!1;f=TWted.caret_position(b);f==b.val().length&&f==TWted.last_caret_pos?1<g?(e=d.index(b),e==d.size()-1?TWted.edit_neighbor(c,"down",g):(b=d.eq(++e),b.focus(),TWted.preview_editbox(b))):TWted.edit_neighbor(c,
"down"):TWted.preview_editbox(b);TWted.last_caret_pos=f;break;default:a=Math.round(b.height());b.height(0);f=1*b.attr("scrH0");d=b.prop("scrollHeight");d=Math.max(d,f);b.height(d);if(c=TWtid.table_element(c))f=c.parent(),g=f.scrollLeft(),e=f.scrollTop(),f.scrollTop(e).scrollLeft(g),4<Math.abs(d-a)&&c.resize();TWted.preview_editbox(b)}},table_edit_mode:function(a,b,c,d){a.closest(".tedTable");TWted.focusout();d||(d=TWtid.wrapper_tiddler(a));c||(c=TWtid.element_index(a,d));d.$wrapper.size();var e=d.tiddler.text.split("\n");
if(TWted.cur_title==d.title){var f=d.$wrapper.size()-1;d.$wrapper.each(function(g,h){var i=jQuery(h),i=TWtid.find_tables(i);"stop"===b?(TWted.stop_edit_mode(TWtid.table_element(i,TWted.cur_ndx,d,g,e),TWted.cur_ndx),g==f&&(TWted.$cur_block=TWted.cur_title=TWted.cur_ndx=null)):TWted.saved_index(c)?b||(TWted.stop_edit_mode(TWtid.table_element(i,TWted.cur_ndx,d,g,e),TWted.cur_ndx),g==f&&(TWted.$cur_block=TWted.cur_title=TWted.cur_ndx=null)):(TWted.stop_edit_mode(TWtid.table_element(i,TWted.cur_ndx,d,
g,e),TWted.cur_ndx),TWted.start_edit_mode(TWtid.table_element(i,c,d,g,e),c,d),g==f&&(TWted.cur_ndx=c,TWted.$cur_block=a))})}else{if(TWted.cur_title){var g={$wrapper:TWtid.wrapper_from_title(TWted.cur_title),tiddler:TWtid.get_tiddler(TWted.cur_title),title:TWted.cur_title},h=g.tiddler.text.split("\n");g.$wrapper.each(function(a,b){var c=jQuery(b),c=TWtid.table_element(TWtid.find_tables(c),TWted.cur_ndx,g,a,h);TWted.stop_edit_mode(c,TWted.cur_ndx)})}d.$wrapper.each(function(a,b){TWted.start_edit_mode(TWtid.table_element(TWtid.find_tables(jQuery(b)),
c,d,a,e),c,d)});TWted.cur_title=d.title;TWted.cur_ndx=c;TWted.$cur_block=a}},$cur_block:null,toggleEditMode:function(a,b,c,d){if(!a||2<a.size())return this;switch(a[0].nodeName){case "TH":case "TD":a=TWtid.table_element(a);TWted.table_edit_mode(a,b,c,d);break;case "TABLE":TWted.table_edit_mode(a,b,c,d);break;default:config.options.chkTWtedNoClick&&(TWted.$cur_block?(TWted.focusout(),TWted.$cur_block[0]!=a[0]?(TWted.$cur_block.is("TABLE")&&TWted.table_edit_mode(TWted.$cur_block,"stop"),TWted.editInPlace(a)&&
(TWted.$cur_block=a)):TWted.$cur_block=null):TWted.editInPlace(a)&&(TWted.$cur_block=a))}return this},restore_scroll_pos:function(a,b,c){(a=TWtid.get_table_info(a.tiddler,b.dIndex,"ScrollPos"))&&c.parent().scrollLeft(a.left).scrollTop(a.top)},prepare_edit_buttons:function(a,b,c){this.start_edit_mode(a,b,c)},start_edit_mode:function(a,b){if(a){TWted.reference_bars(a,b);var c=a.closest("div[id=tiddlerDisplay]"),d=a.parent(),e=d.parent(),f=e.find("div[id^=tedTrefV]").width(),g=e.find("div[id^=tedTrefH]").height();
c.find("[id^=tedTbtn]").not("[id^=tedTmenu] [id^=tedTbtn]").css({left:"+="+f,top:"+="+g});a.find(".noedit").css("opacity",0.5);a.attr("oversize")&&TWtid.table_scrolled(e,d.position(),d.scrollLeft(),d.scrollTop());d=TWtid.button_width()+2;e=d+2;f=c.find("div[id^=tedTmenu]");0<f.size()||(f=jQuery("<div></div>").appendTo(c).css({position:"absolute",width:3*d,height:2*e}).append(TWtid.create_button(String.fromCharCode(60),"Insert column left",function(){TWted.insertColumn(jQuery(this),"left")},"cL").css({position:"absolute",
top:0,left:0})).append(TWtid.create_delete_button("Delete this column",function(){TWted.deleteColumn(jQuery(this))},b,"xC").css({position:"absolute",top:0,left:d})).append(TWtid.create_button(String.fromCharCode(62),"Insert column right",function(){TWted.insertColumn(jQuery(this),"right")},"cR").css({position:"absolute",top:0,left:2*d})).append(TWtid.create_button("C","Copy this column",function(){var a=jQuery(this);TWted.copyColumn(a);a.parent().find("[id^=tedTbtncP]").fadeTo("fast",1)},"cC").css({position:"absolute",
top:e,left:0})).append(TWtid.create_button("X","Cut this column",function(){var a=jQuery(this);TWted.copyColumn(a);TWted.deleteColumn(a,!1);a.parent().find("[id^=tedTbtncP]").fadeTo("fast",1)},"cX").css({position:"absolute",top:e,left:d})).append(TWtid.create_button("P","Paste to this column",function(){var a=jQuery(this);TWtid.button_active(a)&&TWted.pasteColumn(a)},"cP").css({position:"absolute",top:e,left:2*d})).attr("id","tedTmenuH"+b.dIndex).hide(),f=jQuery("<div></div>").appendTo(c).css({position:"absolute",
border:"0",width:2*d,height:3*e}).append(TWtid.create_button(String.fromCharCode(8743),"Insert row above",function(){TWted.insertRow(jQuery(this),"above")},"rU").css({position:"absolute",left:0,top:0})).append(TWtid.create_delete_button("Delete this row",function(){TWted.deleteRow(jQuery(this))},b,"xR").css({position:"absolute",left:0,top:e})).append(TWtid.create_button(String.fromCharCode(8744),"Insert row below",function(){TWted.insertRow(jQuery(this),"below")},"rD").css({position:"absolute",left:0,
top:2*e})).append(TWtid.create_button("C","Copy this row",function(){var a=jQuery(this);TWted.copyRow(a);a.parent().find("[id^=tedTbtnrP]").fadeTo("fast",1)},"rC").css({position:"absolute",top:0,left:d})).append(TWtid.create_button("X","Cut this row",function(){var a=jQuery(this);TWted.copyRow(a);TWted.deleteRow(a,!1);a.parent().find("[id^=tedTbtnrP]").fadeTo("fast",1)},"rX").css({position:"absolute",top:e,left:d})).append(TWtid.create_button("P","Paste to this row",function(){var a=jQuery(this);
TWtid.button_active(a)&&TWted.pasteRow(a)},"rP").css({position:"absolute",top:2*e,left:d})).attr("id","tedTmenuV"+b.dIndex).hide())}},hide_floating_menus:function(){jQuery(document).find("div[id=tiddlerDisplay]").find("div[id^=tedTmenuH]").hide().end().find("div[id^=tedTmenuV]").hide()},remove_edit_buttons:function(a,b){this.stop_edit_mode(a,b)},stop_edit_mode:function(a,b){if(a){this.focusout();TWted.reference_bars(a,b,"remove");TWted.hide_floating_menus();var c=a.parent().parent();a.closest("div[id=tiddlerDisplay]").find("[id^=tedTbtn]").not("[id^=tedTmenu] [id^=tedTbtn]").css({left:"-="+
c.find("div[id^=tedTrefV]").width(),top:"-="+c.find("div[id^=tedTrefH]").height()});a.find(".noedit").css("opacity",1)}},copy_border:function(a,b){a.css({"border-top-width":b.css("border-top-width"),"border-right-width":b.css("border-right-width"),"border-bottom-width":b.css("border-bottom-width"),"border-left-width":b.css("border-left-width")});return this},copy_margin_padding:function(a,b){a.css({"margin-top":b.css("margin-top"),"margin-right":b.css("margin-right"),"margin-bottom":b.css("margin-bottom"),
"margin-left":b.css("margin-left"),"padding-top":b.css("padding-top"),"padding-right":b.css("padding-right"),"padding-bottom":b.css("padding-bottom"),"padding-left":b.css("padding-left")});return this},pre_table_scrolled:null,table_scrolled:function(a,b,c,d){TWted.pre_table_scrolled.apply(this,arguments);a.find("div[id*=tedTrefH]").css("left",b.left-c).end().find("div[id*=tedTrefV]").css("top",b.top-d);if(TWted.$edit_box){var e=TWtid.element_offset(TWted.$cur_elem),f=TWtid.element_offset(TWted.$edit_box),
g=e.left-f.left,e=e.top-f.top;TWted.$edit_box.css({left:"+="+g,top:"+="+e});TWted.$preview.css({left:"+="+g,top:"+="+e})}},ref_bar_v_adjust:function(a){var b=a.parent(),c=b.parent().find("div[id*=tedTrefV]");if(0==c.size())return this;var d=b.scrollTop(),e=TWtid.css_size(b.css("line-height")),f=c.find("span");a.find("tr").each(function(a,b){var c=jQuery(b),k=c.position(),c=c.outerHeight(!0);f.eq(a).css({top:k.top+d+0.5*(c-e)})});return this},ref_bar_v:function(a,b,c){var d=a.parent(),e=d.parent().find("[id^=tedTrefV]");
if(0<e.size())return e;var e=jQuery("<div></div>"),f=d.scrollTop(),g=TWtid.css_size(d.css("line-height"));e.attr("id","tedTrefV"+b.dIndex).css({position:"absolute","z-index":1,top:d.position().top,left:0,width:c}).insertBefore(d);a.find("tr").each(function(a,b){var d=jQuery(b),i=d.position(),m=d.outerHeight(!0);0==m&&(m=d.find("th,td:first").outerHeight(!0));jQuery("<span>"+a+"</span>").appendTo(e).css({border:"0",position:"absolute",padding:0,margin:0,height:g,"text-align":"center",width:c,left:0,
top:i.top+f+0.5*(m-g)}).attr("row",a).click(function(){var a=jQuery(this),b=1*a.attr("row"),a=a.parent(),c=a.attr("last-row"),d=a.parent().find("table").find("tr"),c=c?1*c:-1;-1<c&&d.eq(c).fadeTo(0,1);b!=c?(d.eq(b).fadeTo(0,0.3),a.attr("last-row",b)):a.attr("last-row","")}).mouseenter(function(){var a=jQuery(this),b=TWtid.element_offset(a),c=TWted.$cur_block,d=c.closest("div[id=tiddlerDisplay]").find("div[id^=tedTmenuV]"),e=1*a.index();d.show().css({left:b.left-d.width()/2-2,top:b.top-(d.height()-
a.height())/2}).attr("row",e).find("[id^=tedTbtnrP]").fadeTo("fast",-1<TWted.copied_rndx?1:0.4).end().find("[id^=tedTbtnrU]").css({display:0==e&&c[0].tHead?"none":"inline"}).end().find("[id^=tedTbtnrD]").css({display:e==c[0].rows.length-1&&c[0].tFoot?"none":"inline"})})});return e},ref_bar_h_adjust:function(a){var b=a.parent(),c=b.parent().find("div[id*=tedTrefH]");if(0==c.size())return this;var d=c.find("span"),e=b.scrollLeft();TWtid.row_with_max_col(a).find("th,td").each(function(a,b){var c=jQuery(b),
j=TWtid.css_size(c.css("border-left-width"))+TWtid.css_size(c.css("border-right-width"));d.eq(a).css({width:c.width()+j,left:e+c.position().left})});return this},ref_bar_h:function(a,b){var c=a.parent(),d=c.parent(),e=d.find("[id^=tedTrefH]");if(0<e.size())return e;e=jQuery("<div></div>");a.find("tr").eq(0);var f=c.position(),g=c.scrollLeft(),h=TWtid.css_size(c.css("line-height")),j=d.css("background-color"),k=d.css("color");e.attr("id","tedTrefH"+b.dIndex).css({border:"0",position:"absolute",top:f.top,
left:0,"padding-bottom":4,width:d.width(),height:h}).insertBefore(c);TWtid.row_with_max_col(a).find("th,td").each(function(a,b){var c=jQuery(b),d=jQuery("<span></span>"),f=TWtid.css_size(c.css("border-left-width"))+TWtid.css_size(c.css("border-right-width"));TWtid.copy_margin_padding(d,c);d.css({"background-color":j,color:k,position:"absolute",border:0,"text-align":"center",left:g+c.position().left,width:c.width()+f}).appendTo(e).attr("col",a).click(function(){var a=jQuery(this),b=1*a.attr("col"),
a=a.parent(),c=a.attr("last-col"),d=a.parent().find("table"),e,c=c?1*c:-1;d.find("tr").each(function(a,d){e=jQuery(d).find("th,td");-1<c&&e.eq(c).fadeTo(0,1);b!=c&&e.eq(b).fadeTo(0,0.3)});a.attr("last-col",b!=c?b:"")}).mouseenter(function(){var a=jQuery(this),b=TWtid.element_offset(a),c=TWted.$cur_block.parent().parent().closest("div[id=tiddlerDisplay]").find("div[id^=tedTmenuH]");c.show().css({left:b.left-(c.width()-a.width())/2+4,top:b.top-c.height()}).attr("col",a.index()).find("[id^=tedTbtncP]").fadeTo("fast",
TWted.copied_column?1:0.4)}).text(TWtid.col_ref(a))});return e},reference_bars:function(a,b,c){var d=a.parent(),e=d.parent(),f=e.parent(),g=1*e.attr("v0w"),h=f.find("[id^=tedTCdiv]").outerHeight(!0),j=a.attr("oversize"),k=d.width(),i=d.height(),m=e.find("div[id^=tedTrefV]"),l=e.find("div[id^=tedTrefH]");"remove"==c?0<m.size()&&(a=d.position().top,m.hide(),l.hide(),f.css({width:k}).find("[id^=tedTCdiv]").css("width","-="+g),e.css({width:k+(j?1:0)}),0<i&&(f.css({height:i+h}),e.css({height:i+(j?2:1)})),
d.css({left:0,top:0}),e.find("div.tedTfixedH").css({left:0,top:0}).end().find("div.tedTfixedV").css({left:0,top:0})):(0==m.size()?(m=TWted.ref_bar_v(a,b,g),l=TWted.ref_bar_h(a,b)):(m.show(),l.show()),a=l.outerHeight(!0),f.css({width:k+g,height:i+h+a}).find("[id^=tedTCdiv]").css("width","+="+g),e.css({width:k+g+(j?1:0),height:i+a+(j?2.1:1)}),m.css({top:a}),l.css({left:g}),d.css({top:a,left:g}),e.find("div.tedTfixedH").css({top:a,left:g}).end().find("div.tedTfixedV").css({top:a,left:g}))},pre_inactive_elem:null,
inactive_elem:function(a){var b=TWted.$preview&&(a[0]==TWted.$preview[0]||0<a.closest(".preview").size());b||(b=TWted.$edit_box&&a[0]==TWted.$edit_box[0]);b||(b=TWted.pre_inactive_elem.apply(this,arguments));return b},$btn_US:null,pre_is_button:null,is_button:function(a,b){if(!TWted.$btn_US){var c;config.options.chkTWtedManualUpload&&(c=TWtid.create_button("U","Upload to server",function(){var a=jQuery(this);TWtid.button_active(a)&&config.macros.upload.action()}),TWted.$btn_US=c);config.options.chkTWtedManualSave&&
(c=TWtid.create_button("S","Save to file",function(){var a=jQuery(this);TWtid.button_active(a)&&saveChanges()}),TWted.$btn_US=TWted.$btn_US?TWted.$btn_US.add(c):c);TWted.$btn_US&&TWted.$btn_US.appendTo(b.parent()).hide()}c=TWted.pre_is_button.apply(this,arguments);!c&&!b&&(c=TWted.pre_is_button.call(this,a,TWted.$btn_US));c||(c=a.is("[id^=tedTmenu]")||a.parent().is("[id^=tedTmenu]"));return c},pre_hide_buttons:null,hide_buttons:function(){TWted.$btn_US&&TWted.$btn_US.hide();TWted.pre_hide_buttons.apply(this,
arguments)},pre_focus:null,focus:function(a,b){a?config.options.chkTWtidEnabled&&config.options.chkTWtedEnabled&&(config.options.chkTWtedInViewMode&&!TWted.replaced_ta)&&(TWted.$cur_block?TWted.$cur_block[0]!=a[0]&&(TWted.toggleEditMode(TWted.$cur_block,"stop"),TWted.toggleEditMode(a)):TWted.toggleEditMode(a)):TWted.$cur_block&&TWted.toggleEditMode(TWted.$cur_block,"stop");config.options.chkTWtedNoClick||TWted.pre_focus.apply(this,arguments)},pre_header_click:null,header_click:function(){TWted.$edit_box||
TWted.pre_header_click.apply(this,arguments)},down_elem:null,mousedown:function(a){a=a||window.event;TWted.down_elem=0==a.button||config.browser.isIE&&1==a.button?document.elementFromPoint(a.clientX,a.clientY):null},mouseup:function(a){a=a||window.event;if(0==a.button||config.browser.isIE&&1==a.button){var b=jQuery(document.elementFromPoint(a.clientX,a.clientY));if(b[0]==TWted.down_elem&&!TWtid.is_button(b)){var c=TWtid.cur_block();if(c){if(c.is("table")){if(b.is("TEXTAREA")){setTimeout(function(){TWted.preview_editbox(b)},
0);return}return!TWted.editInPlace(b,a)}if(!TWted.$cur_block||!TWted.$cur_block.is("TABLE"))switch(b[0].nodeName){case "TEXTAREA":b[0]==TWted.$edit_box[0]&&setTimeout(function(){TWted.preview_editbox(b)},0);break;case "SPAN":if(b.is(".preview"))break;default:if(!b.is(".tab"))return!TWted.editInPlace(b,a);TWted.focusout();TWted.$cur_block=null}else config.options.chkTWtedClickAway&&TWted.focusout()}else TWted.focusout()}}},pre_dblclick:null,dblclick:function(a){TWted.pre_dblclick.apply(this,arguments)},
pre_OfficialExample:null,OfficialExample:function(a){var b=TWted.pre_OfficialExample(a);!b&&a&&(b=/^TWted--Example/.test(a));return b},copy_and_cut:function(){},text_before_paste:null,selection_at_paste:null,paste_in:function(a,b,c){var d=b.val();d&&0<d.length?(d=config.options.chkTWtidMultiLine?d.replace(/ <br>/mg,"\n").replace(/<br>/mg,"\n").replace(/ <br \/>/mg,"\n").replace(/<br \/>/mg,"\n"):d.replace(/\n/mg," <br>"),TWted.text_before_paste?b.val(TWted.text_before_paste.substring(0,TWted.selection_at_paste.start)+
d+TWted.text_before_paste.substring(TWted.selection_at_paste.end)):b.val(d),TWted.keydown_after(a,b,c),TWted.caret_position(b,TWted.selection_at_paste.end+d.length)):b.val(TWted.text_before_paste);TWted.text_before_paste=null},paste:function(a){if(!TWted.text_before_paste){var b=jQuery(this);TWted.text_before_paste=b.val();TWted.selection_at_paste=TWted.get_selection(b);b.val("");setTimeout(function(){TWted.paste_in(a,b,TWted.$cur_elem)},0)}},pre_fix_cols_adjust:null,fix_cols_adjust:function(a){TWted.pre_fix_cols_adjust.apply(this,
arguments);TWted.ref_bar_v_adjust(a);return this},pre_fix_rows_adjust:null,fix_rows_adjust:function(a){TWted.pre_fix_rows_adjust.apply(this,arguments);TWted.ref_bar_h_adjust(a);return this},pre_slider_close:null,slider_close:function(a,b){TWted.pre_slider_close.apply(this,arguments);TWted.cur_title==b.title&&TWted.toggleEditMode(TWtid.table_element(TWtid.find_tables(a),TWted.cur_ndx,b),"stop",TWted.cur_ndx,b)},pre_prepare_table:null,prepare_table:function(a,b,c){if(!TWted.pre_prepare_table.apply(this,
arguments)||!config.options.chkTWtedEnabled)return!1;if(!readOnly||TWted.OfficialExample(c.title))if(config.options.chkTWtedEditAllTables||!config.options.chkTWtedInViewMode&&!TWted.replaced_ta||TWtid.hasClass(a,b,"editable",c))TWted.restore_scroll_pos(c,b,a),TWted.cur_title==c.title&&TWted.saved_index(b)&&TWted.start_edit_mode(a,b,c),a.closest(".tedTable").find("div[id^=tedTCdiv]").mouseenter(function(){TWted.hide_floating_menus()}),a.mouseenter(function(){TWted.hide_floating_menus()}),a.bind("resize",
function(){var a=jQuery(this);if(!a.attr("oversize")){var b=a.outerWidth(),c=a.outerHeight(),g=a.parent().parent(),h=g.find("div[id^=tedTrefV]").width(),j=g.find("div[id^=tedTrefH]").outerHeight(!0),k=g.parent(),i=k.find("div[id^=tedTCdiv]").outerHeight(!0);k.css({width:b+h,height:c+j+i});g.css({width:b+h,height:c+j})}TWtid.fix_cols_adjust(a).fix_rows_adjust(a)});return!0},replaced_ta:null,original_text:null,replace_editor:function(a,b){if(config.options.chkTWtidEnabled&&config.options.chkTWtedEnabled){var c=
jQuery(story.getTiddlerField(a,config.options.txtEditorFocus||"text")),d=jQuery("<div></div>");d.addClass("viewer").css({border:"1px solid black",width:c.width()}).attr("tiddler",a).dblclick(function(){if(!TWted.$cur_elem){var a=jQuery(this),b=a.attr("tiddler"),b=store.getTiddlerText(b);TWted.edit_element(a,b);return!1}});b?b.$wrapper=d:b={$wrapper:d,tiddler:TWtid.get_tiddler(a),title:a};c.replaceWith(d);TWted.replaced_ta=c;b.tiddler.text=c.val();TWtid.refresh_wrapper(b,!0)}},pre_edit_handler:null,
edit_handler:function(a,b,c){TWted.focusout();TWted.pre_edit_handler.apply(this,arguments);config.options.chkTWtedInViewMode||(TWted.replace_editor(c),TWted.original_text=TWted.replaced_ta.val());return!1},pre_close_handler:null,close_handler:function(){TWted.replaced_ta=TWted.original_text=null;TWtid.focus();return TWted.pre_close_handler.apply(this,arguments)},pre_save_handler:null,save_handler:function(){TWted.focusout();TWted.replaced_ta=TWted.original_text=null;return TWted.pre_save_handler.apply(this,
arguments)},pre_cancel_handler:null,cancel_handler:function(a,b,c){if(store.isDirty()&&!readOnly&&!confirm(this.warning.format([c])))return!1;TWted.original_text&&(TWtid.get_tiddler(c).text=TWted.original_text);TWted.replaced_ta=TWted.original_text=null;return TWted.pre_cancel_handler.apply(this,arguments)},pre_saveChanges:null,saveChanges:function(){TWted.pre_saveChanges.apply(this,arguments);config.macros.upload&&config.macros.upload.action();TWted.replaced_ta=TWted.original_text=null},pre_closeAllTiddlers:null,
closeAllTiddlers:function(){TWted.pre_closeAllTiddlers.apply(this,arguments);TWtid.focus()},pre_refreshTiddler:null,refreshTiddler:function(a,b,c,d,e){var f=TWted.pre_refreshTiddler.apply(this,arguments);f&&(config.options.chkTWtidEnabled&&config.options.chkTWtedEnabled)&&jQuery(document).unbind("mousedown",TWted.mousedown).bind("mousedown",TWted.mousedown).unbind("mouseup",TWted.mouseup).bind("mouseup",TWted.mouseup);return f},sortable_grid_html:function(a){return'<a href="#" class="sortheader" onclick="config.macros.sortableGridPlugin.ts_resortTable(this);return false;">'+
a+'<span class="sortarrow">&nbsp;&nbsp;&nbsp;</span></a>'}};
//}}}
// @@
