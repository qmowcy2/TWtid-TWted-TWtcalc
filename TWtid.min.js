/***
|editable|k
|''Name:''|TWtid|
|''Description:''|Manipulates tables in wikitext level.|
|''Author:''|Vincent Yeh (qmo.wcy2@gmail.com)|
|''Source:''|* (minimized) http://twtable.tiddlyspace.com/#TWtid.min <br>* (regular) http://twtable.tiddlyspace.com/#TWtid|
|''Type''|plugin|
|''Version:''|1.6.2|
|''Status:''|This plugin is still under development.<br>You are welcome to try and send feedback. :-)|
|''Date:''|2012/10/19 released 1.4.0<br>2012/09/04 started from TableEditor 1.3.0|
|''License:''|Same as TiddlyWiki.|
|''Core Version:''|2.6.5.|

!!Options
Click the {{{C}}} button for related options.
----
of table (so they do not scroll).
>@@color:red;Not yet complete.@@
><<option chkTWtableFixedColWidth>> Fix the column width for tables.
***/

// @@display:none;
//{{{
config.extensions.TWtid={major:1,minor:6,revision:3,date:new Date("2013/04/20")};
config.macros.TWtid={init:function(){void 0===config.options.chkTWtidEnabled&&(config.options.chkTWtidEnabled=void 0===config.options.chkTWtableEnabled?!0:config.options.chkTWtableEnabled);void 0===config.options.txtTWtidMinCellWidth&&(config.options.txtTWtidMinCellWidth=void 0===config.options.txtTWtableMinCellWidth?"8":config.options.txtTWtableMinCellWidth);void 0===config.options.txtTWtidMaxWidth&&(config.options.txtTWtidMaxWidth=void 0===config.options.txtTWtableMaxWidth?"100%":config.options.txtTWtableMaxWidth);
void 0===config.options.txtTWtidMaxHeight&&(config.options.txtTWtidMaxHeight=void 0===config.options.txtTWtableMaxHeight?"5000px":config.options.txtTWtableMaxHeight);void 0===config.options.chkTWtidMultiLine&&(config.options.chkTWtidMultiLine=void 0===config.options.chkTWtableMultiLine?!1:config.options.chkTWtableMultiLine);void 0===config.options.txtTWtidFixRows&&(config.options.txtTWtidFixRows=void 0===config.options.txtTWtableFixRows?"0":config.options.txtTWtableFixRows);void 0===config.options.txtTWtidFixCols&&
(config.options.txtTWtidFixCols=void 0===config.options.txtTWtableFixCols?"0":config.options.txtTWtableFixCols);void 0===config.options.txtTWtidSnapshotFile&&(config.options.txtTWtidSnapshotFile=void 0===config.options.txtTWtableSnapshotFile?"":config.options.txtTWtableSnapshotFile);void 0===config.options.chkTWtidSnapshotHideBtn&&(config.options.chkTWtidSnapshotHideBtn=void 0===config.options.chkTWtableSnapshotHideBtn?!1:config.options.chkTWtableSnapshotHideBtn);void 0===config.options.chkTWtidTranspose&&
(config.options.chkTWtidTranspose=void 0===config.options.chkTWtableTranspose?!1:config.options.chkTWtableTranspose);void 0===config.options.chkTWtidFixedColWidth&&(config.options.chkTWtidFixedColWidth=void 0===config.options.chkTWtableFixedColWidth?!1:config.options.chkTWtableFixedColWidth);merge(config.optionsDesc,{chkTWtidEnabled:"Enable ~TWtid.",txtTWtidMinCellWidth:"Minimum cell width in characters. Default value is 8.",txtTWtidMaxWidth:"Maximum view port width for tables. Wider tables are scrollable. Default is 100% of that of the parent element.",
txtTWtidMaxHeight:"Maximum view port height for tables. Higher tables are scrollable. Default is 500px.",chkTWtidMultiLine:"Multi-line rendering mode. Default is false.",txtTWtidFixRows:"(unstable) Fix the first few rows. The number of first rows, including the header row, to fix at the top of table (so they do not scroll). Default is 0.",txtTWtidFixCols:"(unstable) Fix the first few columns. The number of first columns to fix at the left side of table (so they do not scroll). Default is 0.",txtTWtidSnapshotFile:'Snapshot file name. Empty string to use the default of SnapshotPlugin, "tiddler.title" to use the tiddler title.',
chkTWtidSnapshotHideBtn:"Hide buttons when taking a snapshot. Check to hide all the TWtid buttons and the Snapshot button.",chkTWtidTranspose:"Enable transposition.",chkTWtidFixedColWidth:"(Incomplete) Fix the column width for tables. If true, the option txtTWtidMinCellWidth will be used as the fixed column width (in characters). Otherwise column widths would be variable, with a minimum given in the option txtTWtidMinCellWidth."});TWtid.pre_popup_show=Popup.show;Popup.show=TWtid.popup_show;TWtid.pre_refreshTiddler=
story.refreshTiddler;story.refreshTiddler=TWtid.refreshTiddler;TWtid.pre_tabs_switchTab=config.macros.tabs.switchTab;config.macros.tabs.switchTab=TWtid.tabs_switchTab;TWtid.pre_tiddler_transclude=config.macros.tiddler.transclude;config.macros.tiddler.transclude=TWtid.tiddler_transclude;TWtid.pre_slider_handler=config.macros.slider.handler;config.macros.slider.handler=TWtid.slider_handler;TWtid.pre_onClickSlider=config.macros.slider.onClickSlider;config.macros.slider.onClickSlider=TWtid.onClickSlider;
config.macros.snapshot&&(TWtid.pre_go=config.macros.snapshot.go,config.macros.snapshot.go=TWtid.go);config.browser.isIE10=0<=config.userAgent.indexOf("msie 10.");config.browser.isIE9=0<=config.userAgent.indexOf("msie 9.");config.browser.isIE975=0<=config.userAgent.indexOf("msie 7.")&&0<=config.userAgent.indexOf("trident/5");config.browser.isIE8=0<=config.userAgent.indexOf("msie 8.");config.browser.isIE874=0<=config.userAgent.indexOf("msie 7.")&&0<=config.userAgent.indexOf("trident/4");config.browser.isIE&&
(!config.browser.isIE10&&!config.browser.isIE9&&!config.browser.isIE975&&!config.browser.isIE8&&!config.browser.isIE874)&&displayMessage("TWtid message: Unsupported IE version.\n\n "+config.userAgent+"\n\nPlease inform the author at qmo.wcy2@gmail.com. Thanks.");config.browser.isWin7=0<=config.userAgent.indexOf("nt 6.1");config.browser.isWinXP=0<=config.userAgent.indexOf("nt 5.1");config.browser.isAndroid=0<=config.userAgent.indexOf("android");config.browser.isiOS=config.userAgent.indexOf("mac")>
config.userAgent.indexOf("ip");jQuery(window).resize(function(a){a=a||window.event;TWtid.resize(a)});var a=config.shadowTiddlers.OptionsPanel,b=a.indexOf("----");config.shadowTiddlers.OptionsPanel=a.substring(0,b)+"----\nTWtidOptions\n"+a.substring(b);merge(config.shadowTiddlers,{TWtidOptions:"<<TWtidOptions>>"})}};
config.macros.TWtidOptions={order:{chkTWtidEnabled:0,txtTWtidMinCellWidth:1,txtTWtidMaxWidth:2,txtTWtidMaxHeight:3,chkTWtidMultiLine:4,txtTWtidFixRows:5,txtTWtidFixCols:6,txtTWtidSnapshotFile:7,chkTWtidSnapshotHideBtn:8,chkTWtidTranspose:9,chkTWtidFixedColWidth:10},options_changed:function(a,b){a.each(function(a,d){b=TWtid.wrapper_tiddler(jQuery(d));TWtid.refresh_wrapper(b,!0)})},collect_options:function(a,b){var c,d=[];for(c in config.options)0<=c.indexOf(a)&&config.optionsDesc[c]&&d.push("\n|<<option "+
c+">>|"+config.optionsDesc[c].split(".")[0]+". |");b&&d.sort(function(a,c){var d=a.substring(a.indexOf(" ")+1,a.indexOf(">>")),g=c.substring(c.indexOf(" ")+1,c.indexOf(">>"));return b[d]>b[g]?1:-1});return d},prepare_options_table:function(a,b,c){var d="|"+a+"|c\n| Value | Description |h",a=this.collect_options(b,c);jQuery.each(a,function(a,b){d+=b});return d},show_options_table:function(a,b,c,d){a=jQuery("<div></div>").appendTo(a);b=this.prepare_options_table(b,c,d);wikify(b,a[0]);a.find("table input").css("width",
"5em")},handler:function(a){config.macros.TWtidOptions.show_options_table(a,"TWtid Options","TWtid",this.order)}};
TWtid={index_string:function(a){return"("+a.rIndex+","+a.dIndex+")"},table_changed:function(){},start_sorting:function(){return!0},sortTable:null,ts_resortTable:null,sorting_enabled:function(){return null!=this.sortTable||null!=this.ts_resortTable},sort:function(a,b){var c,d,e=null,f=1*config.options.txtTWtidFixRows;nc=1*config.options.txtTWtidFixCols;switch(a.nodeName){case "A":d=f||nc?jQuery(a).closest("span.tedTfixedHC,span.tedTfixedVC"):jQuery(a).parent();break;default:d=jQuery(a)}if(d.is(".tedTfixedHC,.tedTfixedVC")){var h=
1*d.attr("col");c=d.closest(".tedTable").find("table");if(f||h>=nc)e=d;d=c.find("tr:first").find("th,td").eq(h);a="A"==a.nodeName?d.find("a")[0]:d[0];if(config.tableSorting||config.macros.sortableGridPlugin)h=c.parent().parent(),0<f&&h.find(".tedTfixedHR:first .tedTfixedHC span").hide(),1<nc&&h.find(".tedTfixedVR:first .tedTfixedVC span").hide()}else c=TWtid.table_element(d),(config.tableSorting||config.macros.sortableGridPlugin)&&0<nc&&c.parent().parent().find(".tedTfixedVR:first .tedTfixedVC span").hide();
var h=TWtid.wrapper_tiddler(c),g=TWtid.element_index(c,h);if(TWtid.start_sorting(c,g,h)){var i=[];c.find("tr").each(function(a,b){i[a]=b});config.tableSorting?TWtid.sortTable.apply(this,arguments):config.macros.sortableGridPlugin&&TWtid.ts_resortTable.apply(this,arguments);1<f&&TWtid.fix_rows(c,!1).fix_rows(c,!0,f);0<nc&&TWtid.fix_cols(c,!1).fix_cols(c,!0,nc);TWtid.fix_rows_adjust(c,f);e&&e.find("span:first").html(d.find("span:first").html()).show();c.find("tr").each(function(a,b){jQuery(b).removeClass("oddRow").removeClass("evenRow").addClass(a%
2?"oddRow":"evenRow")});var j=[];c.find("tr").each(function(a,b){j[a]=b});TWtid.init_table_rows(c,!1);d=h.tiddler.text.split("\n");for(var e=[],f=Array(j.length),m=TWtid.table_first_line(d,g,h.title),l=TWtid.table_last_line(d,m),k,g=0;g<d.length;g++)e[g]=d[g];for(g=0;g<i.length;g++)for(k=0;k<j.length;k++)if(j[k]==i[g]){f[k]=g;k!=g&&TWtid.table_changed("ROW MOVED",{text:d,first:m,last:l,from:g,to:k},h);break}for(k=0;k<f.length;k++)rs_ndx=TWtid.line_number_of_table_row(d,m,k),r_ndx=TWtid.line_number_of_table_row(d,
m,f[k]),e[rs_ndx]=d[r_ndx];TWtid.table_changed("SORTED",{table:c,text:e,first:m,last:l},h);TWtid.save_text(h.tiddler,e)}},make_table_row:function(a){for(var b=1,c="|";b<a.length-1;)c+=a[b++]+"|";a[b]&&(c+=a[b]);return c},row_ref:function(a){return a},col_ref:function(a){return a},elem_first_line:function(a,b,c,d,e,f){var f=f?f:0,h=this.tiddler_slice(d);if(h)return-1;h=this.tiddler_section(d);d=0;h&&(d=TWtid.header_to_skip(h),0<d&&(h=TWtid.remove_header_tail(h)));var g=-1,i=-1,j=!h;do if(h&&!j&&"!"==
a[f].charAt(0)&&-1<a[f].indexOf(h)&&(0<d?d--:j=!0),b.test(a[f])){if(j)if(++i,++g,-1<c.dIndex){if(i==c.dIndex)return c.rIndex=g,f}else if(-1<c.rIndex){if(g==c.rIndex)return c.dIndex=i,f}else return c.dIndex=i,c.rIndex=g,f;/^\<\<\w/.test(b.source)?f=this.macro_last_line(a,f):-1<b.source.indexOf("\\{\\{\\{")||TWtid.preformat_first_line(a[f])?f=this.preformat_last_line(a,f+1):/\{\d\}\[/.test(b.source)?f=this.list_last_line(a,f+1,this.list_prefix(a[f])):"^[\\|]"==b.source?f=this.table_last_line(a,f+1):
/\{\d,\d\}/.test(b.source)&&(this.blockexample_first_line(a[f])?f=this.blockexample_last_line(a,f+1):((/^\>{2}/.test(a[f])&&!/^\>{1}/.test(a[f-1])||/^\>{3}/.test(a[f])&&!/^\>{2}/.test(a[f-1]))&&++g,f=this.blockquote_last_line(a,f)))}else if(/\{\d\}\[/.test(b.source)&&e.test(a[f])&&(++i,j))if(++g,-1<c.dIndex){if(i==c.dIndex)return c.rIndex=g,f}else if(g==c.rIndex)return c.dIndex=i,f;while(++f<a.length);return-1},split_line_text:function(a,b,c){for(var a=a.split(b),d=0,e=a.length-1,f,h,g;!a[d]&&d<e;)d++;
for(;!a[e]&&d<e;)e--;for(var i=0;i<c.length;i++)for(var j=d;j<e;j++)if(a[j]&&-1!=(f=a[j].lastIndexOf(c[i].open)))if(g="string"==typeof c[i].close?a[j].lastIndexOf(c[i].close):(h=a[j].match(c[i].close))?a[j].lastIndexOf(h[h.length-1]):-1,f>g&&(g="string"==typeof c[i].close?a[j+1].indexOf(c[i].close):a[j+1].search(c[i].close),f=a[j+1].indexOf(c[i].open),-1<g&&(-1==f||f>g)))a[j]+=b+a[j+1],a.splice(j+1,1),f>g&&--j;return a},escape_string:function(a){return a.replace(/[-/$*#]/g,"\\$&")},list_prefix:function(a,
b){if("string"==typeof a){var c=a,b=c.charAt(0);if(!/^(\*|\#)/.test(b))return null;for(a=1;c.charAt(a)==b;)a++}c="^(*{"+(a+1)+"}|#{"+(a+1)+"})";return{prefix:RegExp(TWtid.escape_string(b?"^"+b+"{"+a+"}[^"+b+"]":"^(*{"+a+"}[^*]|#{"+a+"}[^#])")),subprefix:RegExp(TWtid.escape_string(c))}},list_item_line:function(a,b,c){if("number"==typeof b.rIndex&&"number"==typeof b.dIndex)return this.elem_first_line(a,/^[\*\#]+/,b,c);for(var d=this.list_prefix(1),e=-1==b.dIndex?b.rIndex.split("."):b.dIndex.split("."),
f=0,h={rIndex:-1,dIndex:-1},g=-1==b.dIndex?{rIndex:b.rIndex,dIndex:""}:{rIndex:"",dIndex:b.dIndex},i=0;i<e.length;i++)(-1==b.dIndex?(h.rIndex=+e[i],h.dIndex=-1):(h.rIndex=-1,h.dIndex=+e[i]),i%2)?(f=this.line_number_of_list_item(a,f,-1==b.dIndex?h.rIndex:h.dIndex),-1==b.dIndex?g.dIndex+="."+h.rIndex:g.rIndex+="."+h.rIndex):(i&&(d=this.list_prefix(i/2+1)),f=this.elem_first_line(a,d.prefix,h,c,d.subprefix,f),-1==b.dIndex?g.dIndex+=(i?".":"")+h.dIndex:g.rIndex+=(i?".":"")+h.rIndex);-1==b.dIndex?b.dIndex=
g.dIndex:b.rIndex=g.rIndex;return f},list_last_line:function(a,b,c){do if(!c.subprefix.test(a[b]))break;while(++b<a.length);return b-1},line_number_of_list_item:function(a,b,c){for(var d=a[b].charAt(0),e=1;a[b].charAt(e)==d;)e++;d=this.list_prefix(e,d);e=0;do if(d.prefix.test(a[b])){if(e==c)return b;e++}else if(!d.subprefix.test(a[b]))break;while(++b<a.length);return-1},header_first_line:function(a,b,c,d){return this.elem_first_line(a,/^\!{1,6}/,b,c,null,d)},blockquote_first_line:function(a,b,c){return this.elem_first_line(a,
/^(\>{1,3}|\<\<\<)/,b,c)},blockquote_last_line:function(a,b){for(var c=b,d=a[c].charAt(0),e=1;a[c].charAt(e)==d;)e++;for(var f=a[c].substring(0,e);++c<a.length&&a[c].startsWith(f)&&a[c].charAt(e)!=d;);return c-1},blockexample_first_line:function(a){return/^\<\<\</.test(a)},blockexample_last_line:function(a,b){for(var c=b;c<a.length;){if(/^\<\<\</.test(a[c]))return c;c++}return c-1},preformat_first_line:function(a,b,c){var d=/^(\{\{\{|\/\/\{\{\{|\/\*\{\{\{|\<\!--\{\{\{)/;return"string"==typeof a?d.test(a):
this.elem_first_line(a,d,b,c)},preformat_last_line:function(a,b){for(var c=b;c<a.length;){if(/^(\}\}\}|\/\/\}\}\}|\/\*\}\}\}|\<\!--\}\}\})/.test(a[c]))return c;c++}return c-1},macro_first_line:function(a,b,c,d){return this.elem_first_line(a,RegExp("<<"+d),c)},macro_last_line:function(a,b){for(var c=b;c<a.length&&!/\>\>$/.test(a[c]);)c++;return c},table_first_line:function(a,b,c){return this.elem_first_line(a,/^[\|]/,b,c)},table_last_line:function(a,b){for(var c=b;c<a.length;)if(/^[\|]/.test(a[c]))c++;
else break;return c-1},transpose_table:function(a,b,c){var d,e,f=0,h,g=[],i=!1,j,m,l=null,k=[],n;for(d=b;d<=c;d++)if(!/[cCkK]$/.test(a[d])){++f;i=/[hH]$/.test(a[d]);h=this.split_table_row(a[d]);for(e=0;e<h.length-2;e++){a:{for(j=0;j<k.length;j++)if(k[j].col==e){n=j;break a}n=null}j=h[e+1];if("~"==j){if(j=">",null===n&&(k.push({start:f-1,end:-1,col:e}),n=k.length-1),d==c)k[n].end=f}else">"==j?(j="~",l||(l={start:e,end:-1}),null!==n&&(k[n].end=f-1)):(null!==n&&(k[n].end=f-1),l&&(l.end=e),i&&/^[^\!]/.test(j.trim())&&
(j=0<(m=j.search(/\S/))?j.substring(0,m)+"!"+j.substring(m):"!"+j));1==f&&(g[e]=[]);if(null!==n&&-1<k[n].end){var o=k[n].start,u=k[n].end;d==c?j=g[e][o]:g[e][u]=g[e][o];g[e][o]=">";k.splice(n,1)}l&&-1<l.end?(g[l.start][f]=j,g[l.end][f]="~",l=null):g[e][f]=j}}for(d=0;d<g.length;d++)g[d].push(""),g[d]=this.make_table_row(g[d]);if(g.length>f){e=0;for(d=b;d<=c;d++)/[cCkK]$/.test(a[d])||(a[d]=g[e++]);for(;e<g.length;)a.splice(d++,0,g[e++])}else{e=b;for(d=0;d<g.length;)/[^cCkK]$/.test(a[e])?a[e++]=g[d++]:
e++;a.splice(e,c-e+1)}},line_number_of_table_row:function(a,b,c){var d=0;do if(!/[kKcC]$/.test(a[b])){if(d==c)break;d++}while(++b<a.length&&a[b].startsWith("|"));return b},split_table_row:function(a){return this.split_line_text(a,"|",[{open:"[[",close:"]]"},{open:"{{{",close:"}}}"},{open:"file:///",close:/^[\/][\w]+[\w\.\/\#]/}])},cell_index_in_line:function(a,b){if(0>b||b>=a.length)return-1;for(var c=-1,d=1;d<a.length-1;d++)if(">"!=a[d]&&"~"!=a[d]&&c++,c==b)return d;return-1},cell_wiki_ndx:function(a,
b,c,d,e,f){for(var b=this.line_number_of_table_row(a,b,c),h,g=[],i,c=0;c<e;c++,b++){i=this.split_table_row(a[b]);if(0==c&&-1==(h=this.cell_index_in_line(i,d)))h=i.length-1,i.push("");g.push([]);for(d=f-1;0<=d;d--)g[c].push(i[h-d])}return{rndx:b,cndx:h,text:g}},cell_wiki:function(a,b,c,d,e,f){return this.cell_wiki_ndx(a,b,c,d,e,f).text},skip_style_text:function(a){if(0==a.length||" "==a.charAt(0)||"@"==a.charAt(0))return 0;var b=0,c,d;do if(c=a.indexOf(":",b+1),0<c){d=a.indexOf("@@",b);if(0<=d&&d<
c)return b;d=a.indexOf(";",c+1);if(d>c){if(/[\s\,\.]/.test(a.substring(c+1,d)))return b;b=d+1}else return b}else return b;while(1)},elem_wide_style_text:function(a){var b=this.skip_style_text(a);return 0<b?a.substring(0,b):""},remove_style_text:function(a){if(!a)return"";var b=this.skip_style_text(a);return b<a.length?a.substring(b):""},save_text:function(a,b,c){var d="";if(b)if("string"==typeof b)d=b;else for(var d=b[0],e=1;e<b.length;e++)d+="\n"+b[e];else d=a.text;if(c){if(store.tiddlerExists(c)){if(!confirm(config.messages.overwriteWarning.format([c])))return null;
story.closeTiddler(c,!1)}b=story.getTiddler(a.title);b.id=story.tiddlerId(c);b.setAttribute("tiddler",c);store.saveTiddler(a.title,c,d);return d}c=null;config.macros.undo&&(c=store.undo_saveTiddler,store.undo_saveTiddler=function(){},store.saveTiddler(a.title,a.title,d));a.set(a.title,d,a.modifier,new Date);store.setDirty(!0);config.macros.undo&&(store.undo_saveTiddler=c);return d},css_size:function(a,b){if(!a)return 0;var a=a.toLowerCase(),c=a.substring(a.length-2);switch(c){case "px":return Math.round(parseFloat(a));
case "pt":return Math.round(16*parseFloat(a)/12);default:var d=parseFloat(a),e=b?3>b.size()?b:jQuery(b[2]):jQuery(document).find("div[id=tiddlerDisplay]");if(isNaN(d))return this.css_size(e.css(a),e);e=16*parseFloat(e.css("font-size"))/12;if("em"==c)return Math.round(d*e);if("%"==c.charAt(1))return Math.round(d/100*(b?b.width():e))}},tiddlers_recorded:null,push_tiddler:function(a){this.tiddlers_recorded?-1==this.tiddlers_recorded.indexOf(a)&&this.tiddlers_recorded.push(a):(this.tiddlers_recorded=
[],this.tiddlers_recorded.push(a))},save_table_info:function(a,b,c,d){a.table_info||(a.table_info=[]);var e=a.table_info[b],c=void 0===d?c:{info_key:d};e||(e={});a.table_info[b]=merge(e,c);this.push_tiddler(a)},get_table_info:function(a,b,c){return!a||!a.table_info?null:void 0===b?a.table_info:(a=a.table_info[b])?c?a[c]:a:null},resize:function(){if(!config.browser.isAndroid&&!(config.browser.isiOS||config.browser.isIE&&!config.browser.isIE9)){var a=jQuery(document);a.find("div.viewer").each(function(a,
c){TWtid.refresh_wrapper(jQuery(c),!0)});a=a.find("#sidebar,#mainMenu");jQuery(window).width()<screen.width/2?a.hide():a.show()}},element_classes:function(a){return a[0].className},element_attributes:function(a){for(var b="",c=0,a=a[0].attributes;c<a.length;c++)var d=a.item(c),b=b+(d.nodeName+"="+d.nodeValue+"\n");return b},element_index:function(a,b){var c={rIndex:-1,dIndex:-1},d="",e={selector:"",macro:""},f=null;switch(a[0].nodeName){case "TABLE":e.selector=a[0].nodeName;f=TWtid.table_first_line;
break;case "LI":e.selector=a[0].nodeName;f=TWtid.list_item_line;break;case "BLOCKQUOTE":e.selector=a[0].nodeName;f=TWtid.blockquote_first_line;break;case "PRE":e.selector=a[0].nodeName;f=TWtid.preformat_first_line;break;case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":e.selector="h1,h2,h3,h4,h5,h6";f=TWtid.header_first_line;break;default:e=TWtid.wrapper_info(a);if(!e.selector)return c;f=TWtid.macro_first_line}b.$wrapper.each(function(b,f){var h=jQuery(f),m;m="LI"==e.selector?TWtid.find_list_items(h):
TWtid.find_elements(h,e.selector);c.rIndex=m.index(a);if(-1!=c.rIndex)return d=TWtid.title_from_wrapper(h),!1});d||(d=b.title);var h=b.tiddler.text.split("\n");f&&f.call(this,h,c,d,e.macro);return c},element_offset:function(a){var b=a.offset();config.extensions.tiddlyspace&&(b.top-=a.closest("#displayArea").offset().top);return b},hide_buttons:function(){TWtid.$btn_lt&&TWtid.$btn_lt.hide()},attach_all_buttons:function(a){TWtid.attach_buttons(a,"LT",TWtid.$btn_lt)},attach_buttons:function(a,b,c){a||
c.hide()},button_active:function(a){return"1"==a.css("opacity")},create_button:function(a,b,c,d){var e=Math.round(TWtid.css_size("1em")),b=jQuery(createTiddlyButton(null,a,b,c));"object"==typeof ndx&&(ndx=ndx.dIndex);b.attr("id","tedTbtn"+(d?d:a)).css({position:"absolute",fontFamily:"Helvetica, Arial",fontSize:"1em","background-color":"#fff8dc",color:"#000000","z-index":1,"text-align":"center",width:e/2,height:e});return b},create_delete_button:function(a,b,c){return this.create_button("\u2297",a,
b,c)},cell_row_index:function(a){var a=a.parent(),b=a.attr("row");return b?1*b:a[0].rodIndex},table_element:function(a,b,c,d,e){if(0==a.size())return null;switch(a[0].nodeName){case "TABLE":if(!b)return a;e||(e=c.tiddler.text.split("\n"));c=TWtid.title_from_wrapper(jQuery(c.$wrapper.get(d)))||c.title;return-1<TWtid.table_first_line(e,b,c)?jQuery(a.get(b.rIndex)):null;case "TBODY":case "THEAD":case "TR":case "TH":case "TD":return a.closest("table");default:if(a.is(".tedTable"))return a.find("table");
b=a.attr("id");if(/^tedT/.test(b))switch(b.charAt(4)){case "C":case "b":return a.closest(".tedTable").find("table");case "B":case "d":return a.find("table")}}a=config.options.chkTWtidEnabled?a.closest(".tedTable").find("table"):a.closest("table");return 0<a.size()?a:null},copy_font_text:function(a,b,c){c||(c=b.css("vertical-align"));var d=b.css("background-color");switch(d){case "transparent":case "rgba(0, 0, 0, 0)":case "inherit":d=this.elem_bgc(b);default:a.css("background-color",d)}a.css({"font-size":b.css("font-size"),
"font-family":b.css("font-family"),"font-style":b.css("font-style"),color:b.css("color"),"text-align":b.css("text-align"),"vertical-align":c})},copy_html:function(a,b){var c=b.css("vertical-align");switch(c){case "bottom":case "auto":case "middle":var d=TWtid.css_size(a.css("padding-top")),e=jQuery("<div></div>").appendTo(a);0==d&&(d=3);e.html(b.html()).css({width:a.width(),height:a.height(),position:"absolute",top:d+(a.height()-e.height())/2+(config.browser.isIE975?0.5:0)});break;default:a.html(b.html())}TWtid.copy_font_text(a,
b,c)},copy_border:function(a,b){a.css({"border-top-style":b.css("border-top-style"),"border-top-width":Math.round(parseFloat(b.css("border-top-width"))),"border-top-color":b.css("border-top-color"),"border-right-style":b.css("border-right-style"),"border-right-width":Math.round(parseFloat(b.css("border-right-width"))),"border-right-color":b.css("border-right-color"),"border-bottom-style":b.css("border-bottom-style"),"border-bottom-width":Math.round(parseFloat(b.css("border-bottom-width"))),"border-bottom-color":b.css("border-bottom-color"),
"border-left-style":b.css("border-left-style"),"border-left-width":Math.round(parseFloat(b.css("border-left-width"))),"border-left-color":b.css("border-left-color")});return this},copy_margin_padding:function(a,b){a.css({"margin-top":b.css("margin-top"),"margin-right":b.css("margin-right"),"margin-bottom":b.css("margin-bottom"),"margin-left":b.css("margin-left"),"padding-top":b.css("padding-top"),"padding-right":b.css("padding-right"),"padding-bottom":b.css("padding-bottom"),"padding-left":b.css("padding-left")});
return this},elem_bgc:function(a){for(var b;"transparent"==(b=a.css("background-color"))||"rgba(0, 0, 0, 0)"==b||"inherit"==b;)if(a=a.parent(),0==a.size()){b="#fff";break}return b},fixed_cell_left:function(a,b,c){return a+(config.browser.isIE?config.browser.isIE874?2*-b-(0<c?0:1):config.browser.isIE9?0:2*-b:config.browser.firefoxDate?config.browser.isLinux?0<c?-b:0:-b:2*-b)},fixed_cell_width:function(a,b,c){0==b&&(b=1);var d=a.innerWidth(),a=(d-a.width())/b-1;return d-a+(config.browser.isIE?config.browser.isIE874?
-b+1:0:config.browser.firefoxDate?0<c?-b:0:config.browser.isChrome&&config.browser.isLinux?0<c?0:-0.5:0)},fixed_cell_top:function(a,b,c){return a+(config.browser.isIE?config.browser.isIE874?-b*(0<c?2:3):config.browser.isIE975?2*-b-1:config.browser.isIE8?-b*(0<c?2:1)-1:-b*(0<c?2.5:2):config.browser.firefoxDate?-b:2*-b)},fixed_cell_height:function(a,b,c){return a+(config.browser.isIE?config.browser.isIE975||config.browser.isIE8?b:config.browser.isIE874?b+(0<c?0.5:0):b*(0<c?1:2):config.browser.firefoxDate?
0.5*b:config.browser.isSafari?b*(config.browser.isLinux?0<c?-0.25:0.5:1):b)},fix_rows_adjust:function(a,b){if(!a.attr("oversize"))return this;b||(b=1*config.options.txtTWtidFixRows);if(0==b)return this;var c=a.parent(),d=c.scrollLeft(),e=c.parent().find(".tedTfixedHR"),f=1;a.find("tr").slice(0,b).each(function(a,b){var c=e.eq(a).find(".tedTfixedHC");jQuery(b).find("th,td").each(function(b,e){var g=jQuery(e),k=c.eq(b);0==a&&0==b&&(f=TWtid.css_size(g.css("border-left-width")));k.css({left:TWtid.fixed_cell_left(g.position().left+
d,f,b),width:TWtid.fixed_cell_width(g,f,b)})})});return this},border_top_width:function(a){return config.browser.firefoxDate&&config.browser.isLinux?1.5*a:config.browser.isIE9?1:a},check_tableSorting:function(a,b){config.tableSorting&&(a[0].onclick=function(){config.tableSorting.sortTable(this);return!1},b.find("span:first").is(".hidden")&&a.find("span:first").hide())},fix_rows:function(a,b,c){if(!a.attr("oversize"))return this;c||(c=1*config.options.txtTWtidFixRows);if(0==c)return this;var d=a.parent().parent(),
e=d.find("div.tedTfixedH");if(b){if(0<e.size())return this;var b=a.parent(),f=b.scrollLeft(),h=b.scrollTop(),g=b.position(),i=TWtid.css_size(a.css("border-top-width")),j=a.css("border-top-color"),e=jQuery("<div></div>").appendTo(d).css({"border-left":i+"px solid "+j,"border-top":TWtid.border_top_width(i)+"px solid "+j,position:"absolute","z-index":2,overflow:"hidden",left:g.left,top:g.top,width:b[0].clientWidth-(config.browser.isLinux?config.browser.isChrome||config.browser.isOpera?i:0:0)}).addClass("tedTfixedH"),
m=this.elem_bgc(a),l=0;a.find("tr").slice(0,c).each(function(b,c){var d=jQuery(c);d.position();var g=d.innerHeight(),j=d.css("background-color"),p=jQuery("<span></span>").appendTo(e).addClass("tedTfixedHR");if("transparent"==j||"rgba(0, 0, 0, 0)"==j)j=m;d.find("th,td").each(function(c,d){var e=jQuery(d),m=e.attr("rowspan"),l=e.position(),n=e.outerHeight(!0),o=e.height(),r=jQuery("<span></span>").appendTo(p).addClass("tedTfixedHC"),s=e.css("background-color");if("transparent"==s||"rgba(0, 0, 0, 0)"==
s)s=j;TWtid.copy_border(r,e);TWtid.copy_margin_padding(r,e);1==(m?1*m:1)&&n>g&&(g=n);0==b&&0==c&&(i=TWtid.css_size(e.css("border-top-width")));r.attr({col:c}).css({"background-color":s,position:"absolute",left:TWtid.fixed_cell_left(l.left+f,i,c),width:TWtid.fixed_cell_width(e,i,c),top:TWtid.fixed_cell_top(l.top+h,i,b),height:TWtid.fixed_cell_height(o,i,b)});TWtid.copy_html(r,e);a[0].tHead&&0==b&&TWtid.check_tableSorting(r,e)});g+=config.browser.isIE?i:config.browser.firefoxDate?0.5*i:0;p.css({position:"absolute",
height:g});l+=g});e.height(l);TWtid.table_scrolled(d,g,f,h)}else e.remove();return this},fix_cols_adjust:function(a,b){if(!a.attr("oversize"))return this;b||(b=1*config.options.txtTWtidFixCols);if(0==b)return this;var c=a.parent(),d=c.scrollTop(),e=c.parent().find(".tedTfixedVR"),f=0;a.find("tr").each(function(a,b){var c=jQuery(b),j=e.eq(a).css({top:c.position().top,height:c.outerHeight()}).find(".tedTfixedVC");c.find("th,td").slice(0,j.size()).each(function(b,c){var e=jQuery(c),g=e.height();0==a&&
0==b&&(f=TWtid.css_size(e.css("border-top-width")));j.eq(b).css({top:TWtid.fixed_cell_top(d,f,a),width:TWtid.fixed_cell_width(e,f,b),height:TWtid.fixed_cell_height(g,f,a)})})});return this},fix_cols:function(a,b,c){if(!a.attr("oversize"))return this;c||(c=1*config.options.txtTWtidFixCols);if(0==c)return this;var d=a.parent().parent(),e=d.find("div.tedTfixedV");if(b){if(0<e.size())return this;var e=a.parent(),b=e.position(),f=e.scrollTop(),h=e.scrollLeft(),g=TWtid.css_size(a.css("border-left-width")),
i=a.css("border-left-color");d.find("div[id^=tedTrefV]").width();var e=jQuery("<div></div>").appendTo(d).css({"border-left":g+"px solid "+i,"border-top":TWtid.border_top_width(g)+"px solid "+i,position:"absolute","z-index":1,overflow:"hidden",left:b.left,top:b.top,height:e[0].clientHeight-(0==g?1:config.browser.isChrome&&config.browser.isLinux?1.5*g:g)}).addClass("tedTfixedV"),j=[],m=jQuery("<div></div>").appendTo(e).css({position:"absolute",top:b.top,height:a.height()}).addClass("tedTfixedVT"),l=
this.elem_bgc(a);a.find("tr").each(function(b,d){var e=jQuery(d),i=e.css("background-color"),k=e.position(),v=e.outerHeight(!0),e=e.find("th,td").slice(0,c),t=jQuery("<div></div>").appendTo(m).addClass("tedTfixedVR");if("transparent"==i||"rgba(0, 0, 0, 0)"==i)i=l;t.css({position:"absolute",top:k.top,height:v});e.each(function(c,d){var e=jQuery(d),k=e.attr("colspan"),m=e.position(),l=e.height();e.width();var o=e.outerWidth(!0)+(config.browser.firefoxDate?0:1),p=e.css("background-color"),q=jQuery("<span></span>").appendTo(t).addClass("tedTfixedVC");
if("transparent"==p||"rgba(0, 0, 0, 0)"==p)p=i;1==(k?1*k:1)&&(0==b?j[c]=o:o>j[c]&&(j[c]=o));0==b&&0==c&&(g=TWtid.css_size(e.css("border-left-width")));TWtid.copy_border(q,e);TWtid.copy_margin_padding(q,e);0==b&&q.attr({col:c});q.css({"background-color":p,position:"absolute",left:TWtid.fixed_cell_left(m.left+h,g,c),width:TWtid.fixed_cell_width(e,g,c),top:TWtid.fixed_cell_top(f,g,b),height:TWtid.fixed_cell_height(l,g,b)});TWtid.copy_html(q,e);a[0].tHead&&0==b&&TWtid.check_tableSorting(q,e)})});var k=
0;jQuery.each(j,function(a,b){k+=b});m.width(k);e.width(k).find(".tedTfixedVR").width(k);TWtid.table_scrolled(d,b,h,f)}else e.remove();return this},create_table_wrappers:function(a,b,c){a.css({margin:"0",padding:"0","border-spacing":"0","border-collapse":"collapse"});var d=jQuery("<div></div>"),e=jQuery("<div></div>"),f=jQuery("<div></div>"),h=jQuery("<div></div>"),g=a[0].caption?a.contents(":first"):null,i=a.outerHeight(!0),j=TWtid.table_width(a,!0);a.replaceWith(d);a.appendTo(f);d.css({position:"relative"}).addClass("tedTable");
f.addClass("tedTbody").css({border:0,overflow:"auto",position:"relative"}).attr("id","tedTBdiv"+b.dIndex).appendTo(e);e.css({border:0,overflow:"hidden",position:"relative"}).attr("id","tedTdiv"+b.dIndex).appendTo(d);h.css({position:"relative","text-align":"center",overflow:"hidden"}).attr("id","tedTCdiv"+b.dIndex).prependTo(d);d=g?g.html():"&nbsp;";b=jQuery("<span></span>").appendTo(h).addClass("tedTcap").attr("title","Table "+b.dIndex+" in "+c);b.html(d);a[0].caption?g.detach():i+=b.outerHeight(!0);
return{w:j,h:i}},wt_in_sync:null,sync_ndx:0,reformat_table:function(a,b,c){var d={w:0,h:0};a.parent().is("[id^=tedTBdiv]")?(d.w=a.outerWidth(!0),d.h=a.outerHeight(!0)):d=TWtid.create_table_wrappers(a,b,c);var b=a.parent(),c=b.parent(),e=c.parent(),f=e.find("[id^=tedTCdiv]"),h=a.parent(),g=TWtid.css_size(config.options.txtTWtidMaxHeight.trim(),h),i=TWtid.css_size(config.options.txtTWtidMaxWidth.trim(),h),j=TWtid.css_size(h.css("font-size")),m=a[0].rows.length;TWtid.scroll_bar_width(b);for(var h=f.outerHeight(!0),
l=j;1<(m/=10);)l+=j;l==j&&(l=2*j);j=!1;d.w+l+2>i&&(j=!0,d.w=i-l-1);b.width(d.w);f.width(d.w);c.width(d.w).attr("v0w",l);e.width(d.w);d.h+2>g&&(j=!0,d.h=g-2,b.height(d.h-h),c.height(d.h-h+1),e.height(d.h+2));a.attr("oversize",j?"true":"");TWtid.css_size(f.css("line-height"));j?b.scroll(function(){var a=jQuery(this),b=a.parent(),c=a.find("table"),d=a.scrollLeft(),e=a.scrollTop();TWtid.table_scrolled(b,a.position(),d,e);if(!TWtid.wt_in_sync){var f=TWtid.wrapper_tiddler(c),g=TWtid.element_index(c,f);
TWtid.wt_in_sync=f;TWtid.save_table_info(f.tiddler,g.dIndex,{ScrollPos:{left:d,top:e}});f.$wrapper.each(function(a,b){var c=TWtid.table_element(TWtid.find_tables(jQuery(b)),g,f,a);c&&c.parent().scrollLeft(d).scrollTop(e)})}if(++TWtid.sync_ndx==TWtid.wt_in_sync.$wrapper.size()){TWtid.wt_in_sync=null;TWtid.sync_ndx=0}}):b.unbind("scroll");return j},table_scrolled:function(a,b,c,d){var b=a.find("div.tedTfixedH"),e=a.find("div.tedTfixedV"),f=a.find("table"),a=TWtid.css_size(f.css("border-left-width")),
f=TWtid.css_size(f.css("border-top-width"));0==f&&(f=1);b.css("border-left-width",c?0:a).find(".tedTfixedHR").css("left",(c?a:0)+(config.browser.isChrome&&config.browser.isLinux?0.2:0)-c);e.css("border-top-width",d?0:f).find(".tedTfixedVT").css("top",(d?f:0)+(config.browser.isChrome&&config.browser.isLinux?0.25:config.browser.isIE9?1.25:0)-d)},remove_math:function(a){for(var b=0,c=0;b<a.length;){var d=!0,c=a.indexOf("(",b);-1==c&&(d=!1,c=a.indexOf("["));if(-1==c)return 0<b?a.substring(b):a;if(c>b)return a.substring(b,
c);b=a.indexOf(d?")":"]",b+2)+2}return""},tiddler_slice:function(a){if(!a)return"";var b=a.indexOf(config.textPrimitives.sliceSeparator);return-1<b?a.substring(b+config.textPrimitives.sliceSeparator.length):""},tiddler_section:function(a){if(!a)return"";var b=a.indexOf(config.textPrimitives.sectionSeparator);return-1<b?a.substring(b+config.textPrimitives.sectionSeparator.length):""},tiddler_title:function(a){var b=a.indexOf(config.textPrimitives.sectionSeparator);-1==b&&(b=a.indexOf(config.textPrimitives.sliceSeparator));
return-1<b?a.substring(0,b):a},get_tiddler:function(a,b){if(!b||"story"!=b&&"store"!=b)b=store;return b.getTiddler(this.tiddler_title(a))},direct_wrapper:function(a,b){var c=null;if(b){if(1==b.$wrapper.size())return b.$wrapper;b.$wrapper.each(function(b,e){if(jQuery.contains(e,a[0]))return c=jQuery(e),!1});return c}return a.closest(".tabContents,span[tiddler],.sliderPanel,.viewer")},is_wrapper:function(a){return a.is(".viewer,.tabContents,span[tiddler],.sliderPanel")},wrapper_info:function(a){var b=
{selector:"",macro:""};a.is("div.viewer,#tiddlerDisplay")?b.selector="div.viewer,#tiddlerDisplay":a.is("span[tiddler]")?(b.selector="span[tiddler]",b.macro="tiddler"):a.is(".tabContents")?(b.selector=".tabContents",b.macro="tabs"):a.is(".tabset")?(b.selector=".tabset",b.macro="tabs"):a.is("div.sliderPanel")?(b.selector="div.sliderPanel",b.macro="slider"):a.is("span.sliderPanel")&&(b.selector="span.sliderPanel",b.macro="foldHeadings");return b},wrapper_from_title:function(a,b){a=this.remove_math(a);
if(""===a)return null;var c=this.tiddler_title(a),d=jQuery(document).find("div[id=tiddlerDisplay]"),e,f,h;if(c==a)return e=d.find('div[tiddler*="'+a+'"]'),f=d.find('span[tiddler*="'+a+'"]'),h=d.find('.tabSelected[content*="'+a+'"]').parent().next(),h.add(f).add(e);a=TWtid.remove_header_tail(a);e=d.find('div[tiddler*="'+a+'"]');f=d.find('span[tiddler*="'+a+'"]');h=d.find('.tabSelected[content*="'+a+'"]').parent().next();if(b)return h.add(f).add(e);var g=d.find('div[tiddler="'+c+'"]'),i=d.find('span[tiddler="'+
c+'"]'),c=d.find('.tabSelected[content="'+c+'"]').parent().next();return h.add(c).add(f).add(i).add(e).add(g)},title_from_wrapper:function(a){var b=a.attr("tiddler");return b?b:a.is("#tiddlerDisplay")?a.find("[tiddler]").attr("tiddler"):a.is(".viewer")?a.parent().attr("tiddler"):a.is(".tabSelected")?a.attr("content"):a.is(".tabContents")?a.parent().find(".tabSelected").attr("content"):""},wrapper_tiddler:function(a,b){var c={$wrapper:null,tiddler:null,title:TWtid.title_from_wrapper(a)};if(c.title){if(c.tiddler=
this.get_tiddler(c.title))c.$wrapper=this.wrapper_from_title(c.title);return c}var d,e=!1;if(!b&&(d=a.closest("span[tiddler]"),0<d.size()?c.title=d.attr("tiddler"):(d=a.closest(".tabContents"),0<d.size()&&(c.title=d.parent().find(".tabSelected").attr("content"))),c.title)){config.macros.foldHeadings&&(d=a.closest("span.sliderPanel"),0<d.size()&&(e=!0,c.title+=TWtid.header_title(d.prev()),c.$wrapper=d));if(c.tiddler=this.get_tiddler(c.title))d=this.wrapper_from_title(c.title,e),c.$wrapper?c.$wrapper.add(d):
c.$wrapper=d;return c}d=a.closest("div[tiddler]");if(0<d.size()&&(c.title=d.attr("tiddler"),config.macros.foldHeadings&&(d=a.closest("span.sliderPanel"),0<d.size()&&(e=!0,c.title+=TWtid.header_title(d.prev()),c.$wrapper=d)),c.tiddler=this.get_tiddler(c.title)))d=this.wrapper_from_title(c.title,e),c.$wrapper?c.$wrapper.add(d):c.$wrapper=d;return c},find_wrapper:function(a){return"string"==typeof a?this.wrapper_from_title(this.tiddler_title(a)):this.wrapper_tiddler(a).$wrapper},find_tiddler:function(a){return this.wrapper_tiddler(a).tiddler},
init_table_rows:function(a,b,c,d,e){a=a.find("tr");a.each(function(a,b){jQuery(b).attr("row",a)});if(b&&config.options.chkTWtidMultiLine){var f=TWtid.table_first_line(e,c,d),h,g,i;a.each(function(a,b){h=TWtid.line_number_of_table_row(e,f,a);e[h]&&(g=TWtid.split_table_row(e[h]),jQuery(b).find("th,td").each(function(a,b){if(i=TWtid.remove_style_text(g[TWtid.cell_index_in_line(g,a)]))/<br/.test(i)?(i=i.replace(/ <br>/mg,"\n").replace(/<br>/mg,"\n").replace(/ <br \/>/mg,"\n").replace(/<br \/>/mg,"\n"),
jQuery(b).empty(),wikify(i,b)):/^[\*\#]/.test(i.trim())&&(jQuery(b).empty(),wikify(i,b))}))})}},scroll_bar_width:function(a){var b=a.css("overflow");a.css("overflow","scroll");var c=a[0],c=c.offsetWidth-c.clientWidth;a.css("overflow",b);return c},row_with_max_col:function(a){var b=a.attr("maxcol");if(b)return a.find("tr").eq(1*b);var c=null,d=0;a.find("tr").each(function(b,f){f.cells.length>d&&(d=f.cells.length,c=jQuery(f),a.attr("maxcol",b))});return c},table_width:function(a,b){if(!b)return a.outerWidth(!0);
var c=1*config.options.txtTWtidMinCellWidth,d=0,e=config.options.chkTWtidFixedColWidth;TWtid.row_with_max_col(a).find("th,td").each(function(a,b){var g=jQuery(b),i=TWtid.css_size(g.css("font-size"))*c,j=g.width();e?g.width(i):j<i&&g.width(i);d+=g.outerWidth(!0)});a.width(d);return d},is_button:function(a,b){var c=!1;b||(b=TWtid.$btn_lt);b.each(function(b,e){if(a[0]==e){c=true;return false}});return c},button_width:function(a){a||(a=TWtid.$btn_lt);var b;"none"==a[0].style.display?(a.show(),b=a.width(),
a.hide()):b=a.width();return b+1.5},button_height:function(a){a||(a=TWtid.$btn_lt);var b;"none"==a[0].style.display?(a.show(),b=a.height(),a.hide()):b=a.height();return b},$cur_block:null,cur_block:function(a){if(void 0===a)return TWtid.$cur_block;TWtid.$cur_block=a},$btn_lt:null,inactive_elem:function(a){return TWtid.is_button(a,TWtid.$btn_lt)},element_box:function(a){var b=jQuery(a[0]),c=TWtid.element_offset(b),d;if(3>a.size())d=a.innerWidth(),b=a.innerHeight();else{var e=jQuery(a[2]),f=TWtid.element_offset(e);
d=e.innerWidth();c.left=f.left;jQuery.contains(e[0],b[0])?b=b.outerHeight():(c.top=f.top,b=0);c.top+=b+4;a=jQuery(a[1]);jQuery.contains(e[0],a[0])?(a.is("table")&&(a=a.closest(".tedTable")),b=TWtid.element_offset(a).top-c.top-4):b=f.top+e.height()-c.top+4}return{left:c.left,top:c.top,width:d,height:b}},$border_down:null,$border_left:null,$border_right:null,focus:function(a,b){if(!TWtid.$border_up){var c=jQuery(document).find("div[id=tiddlerDisplay]");TWtid.$border_up=jQuery("<div></div>").appendTo(c).css({position:"absolute",
"border-top-width":"1px","border-top-style":"dashed",height:0});TWtid.$border_down=jQuery("<div></div>").appendTo(c).css({position:"absolute","border-top-width":"1px","border-top-style":"dashed",height:0});TWtid.$border_left=jQuery("<div></div>").appendTo(c).css({position:"absolute","border-left-width":"1px","border-left-style":"dashed",width:0});TWtid.$border_right=jQuery("<div></div>").appendTo(c).css({position:"absolute","border-left-width":"1px","border-left-style":"dashed",width:0})}TWtid.$border_up.hide();
TWtid.$border_down.hide();TWtid.$border_left.hide();TWtid.$border_right.hide();TWtid.$cur_block=null;c=a?a.size():0;if(readOnly||0==c||"off"==b||1==c&&a.is(".tabset"))return!1;var c=1==c&&a.is("table")?a.closest(".tedTable"):a,c=TWtid.element_box(c),d=TWtid.css_size("font-size",a);return c.height>=d&&c.top>d&&c.left>d?(TWtid.$cur_block=a,TWtid.$border_up.css({left:c.left,top:c.top,width:c.width}).show(),TWtid.$border_down.css({left:c.left,top:c.top+c.height,width:c.width}).show(),TWtid.$border_left.css({left:c.left,
top:c.top,height:c.height}).show(),TWtid.$border_right.css({left:c.left+c.width,top:c.top,height:c.height}).show(),!0):!1},mousemove:function(a){var a=a||window.event,b=jQuery(document.elementFromPoint(a.clientX,a.clientY));TWtid.$btn_lt||(TWtid.$btn_lt=TWtid.create_button("H","Scroll to A0",function(){TWtid.button_active(jQuery(this))&&TWtid.$cur_block.parent().animate({scrollLeft:0,scrollTop:0})}),TWtid.$btn_lt=TWtid.$btn_lt.add(TWtid.create_button("T","Transpose",function(){if(!(0<jQuery(this).parent().find(".tedTopt").size())){var a=
TWtid.$cur_block,b=TWtid.wrapper_tiddler(a),e=TWtid.element_index(a,b),a=b.tiddler.text.split("\n"),e=TWtid.table_first_line(a,e,b.title),f=TWtid.table_last_line(a,e);TWtid.transpose_table(a,e,f);TWtid.save_text(b.tiddler,a);TWtid.refresh_wrapper(b,!0)}})),TWtid.$btn_lt.appendTo(this).hide());TWtid.inactive_elem(b)||((a=TWtid.block_element(b,a))?(!TWtid.$cur_blk||TWtid.$cur_blk[0]!=a[0])&&TWtid.focus(a,"on"):TWtid.focus())},wrapper_closed:function(a){a=a.closest(".sliderPanel");return 0<a.size()&&
"none"==a[0].style.display},hasClass:function(a,b,c,d){if(a.hasClass(c))return!0;if(!d||!d.tiddler)return!1;if(config.macros.sortableGridPlugin){a=d.tiddler.text.split("\n");d=TWtid.table_first_line(a,b,d.title);for(b=TWtid.table_last_line(a,d);d<=b;d++)if(/[kK]$/.test(a[d])&&-1<a[d].indexOf(c))return!0}return!1},prepare_table:function(a,b,c,d){if(TWtid.wrapper_closed(a)||0<a.closest(".tedTable").size())return!1;var e=a.parent();e.is("[id^=tedT]")&&(e=e.parent().parent().find("div[id*=tedTCdiv]"));
TWtid.css_size(e.css("line-height"));TWtid.init_table_rows(a,!0,b,c.title,d);config.options.chkTWtidEnabled&&(TWtid.reformat_table(a,b,c.title),a[0].tHead&&(config.tableSorting?TWtid.sortTable||(TWtid.sortTable=config.tableSorting.sortTable,config.tableSorting.sortTable=function(a,b){TWtid.sort(a,b)}):config.macros.sortableGridPlugin&&!TWtid.ts_resortTable&&(TWtid.ts_resortTable=config.macros.sortableGridPlugin.ts_resortTable,config.macros.sortableGridPlugin.ts_resortTable=function(a){TWtid.sort(a)})));
TWtid.fix_rows(a,!0).fix_cols(a,!0);return config.options.chkTWtidEnabled},closest_block:function(a,b,c,d){for(var e=c.clientX,c=c.clientY+d,f,b=0>d?0:b.top+b.height,h=c-b;0<d&&0>h||0>d&&0<h;){if(f=document.elementFromPoint(e,c))if((f=TWtid.block_element(jQuery(f)))&&f[0]!=a[0])break;f=null;c+=d;h=c-b}return f&&!f.is(".tagged,.tagInfo,.tidTags")?f:a},closest_blocks:function(a,b){var c=TWtid.css_size("line-height",a),d=[],e=TWtid.element_box(a);d[0]=TWtid.closest_block(a,e,b,-c)[0];d[1]=TWtid.closest_block(a,
e,b,c)[0];d[2]=a[0];return jQuery.contains(a[0],d[0])||jQuery.contains(a[0],d[1])?jQuery(d):null},is_block_element:function(a){switch(a[0].nodeName){case "DIV":return!0;case "TABLE":return!0;case "LI":case "BLOCKQUOTE":case "PRE":case "H1":case "H2":case "H3":case "H4":case "H5":case "H6":return 0==a.closest("th,td").size()}return!1},system_block:function(a){return a.is(".toolbar,.subtitle,.tiddler,.tagged,.tagInfo,.tidTags")},block_element:function(a,b){if(this.system_block(a))return null;var c=
null;if(TWtid.is_wrapper(a))return b&&(c=TWtid.closest_blocks(a,b)),c?c:a;if(TWtid.is_block_element(a))return a;if(a.is("a.tab"))return a.parent();if((c=TWtid.table_element(a))&&0<c.size())return c;if(a.is("DIV")&&TWtid.$cur_block&&TWtid.$cur_block.is("TABLE")){var c=TWtid.$cur_block.closest(".tedTable"),d=TWtid.element_offset(c);if(b.pageX>=d.left&&b.pageY>=d.top&&b.pageX<=d.left+c.width()&&b.pageY<=d.top+c.height())return TWtid.$cur_block}c=a.closest("h1,h2,h3,h4,h5,h6");if(0<c.size())return c;
c=a.closest("li");if(0<c.size())return c;c=a.closest("blockquote");if(0<c.size())return c;c=a.closest("pre");if(0<c.size())return c;d=null;c=a.closest("span");if(TWtid.is_wrapper(c))return b&&(d=TWtid.closest_blocks(c,b)),d?d:c;c=a.closest("div");return TWtid.is_wrapper(c)?(b&&(d=TWtid.closest_blocks(c,b)),d?d:c):0<c.size()?this.system_block(c)?null:c:null},apparent_dim:function(a){switch(a[0].nodeName){case "TABLE":config.options.chkTWtidEnabled&&(a=a.parent());case "PRE":case "BLOCKQUOTE":return{W:a.width(),
H:a.height()};case "SPAN":case "DIV":if(a.is(".sliderPanel,.tabContents,[tiddler]"))return{W:a.width(),H:a.height()}}var b=0<a.find("span").size()?a.parent():a,c=jQuery("<span></span>");config.browser.isIE?c.html(a.html()):TWtid.copy_html(c,a);c.appendTo(b);a={W:c.outerWidth(!0),H:c.outerHeight(!0)};c.remove();return a},find_text_nodes:function(a){return a.contents().filter(function(){return 3==this.nodeType})},find_elements:function(a,b,c){var d=c?a.children(b):a.find(b),a=a.is(".viewer")?a:a.find("div.viewer");
0<a.size()&&(a=c?a.children("div.sliderPanel \t\t\t\t\t\t\t,div.tabContents \t\t\t\t\t\t\t,span[tiddler]"):a.find("div.sliderPanel \t\t\t\t\t\t\t,div.tabContents \t\t\t\t\t\t\t,span[tiddler]"),0<a.size()&&(d=d.not(c?a.children(b):a.find(b))));return d},find_tables:function(a){return this.find_elements(a,"table")},find_headers:function(a){return this.find_elements(a,"h1,h2,h3,h4,h5,h6")},find_list_items:function(a){var b=this.find_elements(a,"li").not(".tagged li, .tidTags li"),c=jQuery(b[0]);-1<c.text().indexOf("not tagging")&&
(b=b.not(c));return b.not(a.find("td li,th li"))},prepare_elements:function(a,b){if(0!=a.closest("#displayArea").size()&&b&&b.tiddler&&!store.isShadowTiddler(b.tiddler.title)){var c=b.tiddler.text.split("\n");TWtid.find_tables(a).each(function(a,e){var f=jQuery(e);0==f.closest(".syntaxhighlighter").size()&&TWtid.prepare_table(f,{rIndex:a,dIndex:-1},b,c)})}},OfficialExample:function(a){return a?/^TWtid--Example/.test(a):!1},after_math:function(a){var b=jQuery(a[1]);switch(a[1].nodeName){case "TD":case "TH":a=
b.closest("table");TWtid.fix_rows_adjust(a).fix_cols_adjust(a);break;case "SPAN":case "DIV":0<b.closest("#displayArea").size()&&TWtid.find_tables(b).each(function(){var a=jQuery(this);TWtid.fix_rows_adjust(a).fix_cols_adjust(a)})}},check_MathJax:function(){config.extensions.MathJax&&("undefined"!==typeof MathJax&&story.displayTiddler==config.extensions.MathJax.displayTiddler)&&(story.displayTiddler=config.extensions.MathJax.displayTiddler_old,MathJax.Hub.Queue(["Typeset",MathJax.Hub]),MathJax.Hub.Register.MessageHook("End Process",
TWtid.after_math))},slider_close:function(){},header_title:function(a,b,c){var d=a.text(),e=config.macros.foldHeadings.hidelabel;-1==d.indexOf(e)&&(e=config.macros.foldHeadings.showlabel,-1==d.indexOf(e)&&(e=""));d=config.textPrimitives.sectionSeparator+(e?d.substring(e.length).trim():d);if(!c){b||(b=TWtid.wrapper_tiddler(a));b=TWtid.direct_wrapper(a,b);b=TWtid.find_headers(b);a=b.index(a);for(e=c=0;e<a;e++){var f=jQuery(b.get(e));TWtid.header_title(f,null,!0)==d&&c++}0<c&&(d+="?"+c)}return d},lines_of_text:function(a,
b,c,d){if(void 0===d){d=c>=b?a[b]:"";for(b+=1;b<=c;b++)d+="\n"+a[b];return d}d?a.splice(b,c-b+1,d):a.splice(b,c-b+1)},header_content:function(a,b){b||(b=TWtid.wrapper_tiddler(a));var c=TWtid.element_index(a,b),d=b.tiddler.text.split("\n"),e=TWtid.header_first_line(d,c,b.title),c=TWtid.header_first_line(d,{rIndex:-1,dIndex:c.dIndex+1},b.title);-1==c&&(c=d.length);for(var f=d[e+1],e=e+2;e<c;e++)f+="\n"+d[e];return f},header_to_skip:function(a){var b=a.lastIndexOf("?");return 0<b&&b<a.length-1?1*a.substring(b+
1):0},remove_header_tail:function(a){var b=a.lastIndexOf("?");0<b&&(b<a.length-1&&!/[\D]/.test(a.substring(b+1)))&&(a=a.substring(0,b));return a},pre_header_click:null,header_click:function(){TWtid.pre_header_click.apply(this,arguments);var a=jQuery(this),b=TWtid.wrapper_tiddler(a);b.title+=TWtid.header_title(a,b);TWtid.prepare_wrapper(a.next(),b)},prepare_wrapper:function(a,b){function c(a){if("undefined"!==typeof MathJax){var b=a.siblings(".title");0<b.size()&&MathJax.Hub.Queue(["Typeset",MathJax.Hub,
b[0]]);MathJax.Hub.Queue(["Typeset",MathJax.Hub,a[0]])}}a.is(".sliderPanel")&&"none"==a[0].style.display||(config.macros.foldHeadings&&a.find("h1.foldable, h2.foldable, h3.foldable\t\t\t\t\t\t, h4.foldable, h5.foldable").each(function(a,b){TWtid.pre_header_click||(TWtid.pre_header_click=b.onclick);b.onclick=TWtid.header_click}),TWtid.check_MathJax(),b||(b=this.wrapper_tiddler(a)),config.options.chkTWtidEnabled?(TWtid.prepare_elements(a,b),c(a)):(c(a),TWtid.prepare_elements(a,b)))},pre_refreshTiddler:null,
refreshTiddler:function(a,b,c,d,e){var f=jQuery(TWtid.pre_refreshTiddler.apply(this,arguments)),h=f.find(".viewer");0==h.size()&&(h=f);TWtid.prepare_wrapper(h);f.closest("div[id=tiddlerDisplay]").unbind("mousemove",TWtid.mousemove).bind("mousemove",TWtid.mousemove);return f[0]},pre_popup_show:null,popup_show:function(a,b,c){TWtid.pre_popup_show.apply(this,arguments);var d=Popup.stack[Popup.stack.length-1];TWtid.prepare_wrapper(jQuery(d.popup));return d},pre_tabs_switchTab:null,tabs_switchTab:function(a,
b){TWtid.pre_tabs_switchTab.apply(this,arguments);var c=jQuery(a);0<c.closest("div[id=tiddlerDisplay]").size()&&(c=c.next(),TWtid.prepare_wrapper(c),config.tableSorting&&config.tableSorting.refresh&&config.tableSorting.refresh(c[0]))},pre_tiddler_transclude:null,tiddler_transclude:function(a,b,c){TWtid.pre_tiddler_transclude.apply(this,arguments);var d=jQuery(a);0<d.closest("div[id=tiddlerDisplay]").size()&&TWtid.prepare_wrapper(d)},pre_slider_handler:null,slider_handler:function(a,b,c){TWtid.pre_slider_handler.apply(this,
arguments);var d=jQuery(a);0<d.closest("div[id=tiddlerDisplay]").size()&&TWtid.prepare_wrapper(d.find("div[tiddler]"))},pre_onClickSlider:null,onClickSlider:function(){TWtid.pre_onClickSlider.apply(this,arguments);TWtid.prepare_wrapper(jQuery(this).next())},refresh_wrapper:function(a,b){var c=jQuery(window),d=c.scrollLeft(),e=c.scrollTop();if(a.jquery)var f=TWtid.wrapper_tiddler(a),a={$wrapper:a,tiddler:f.tiddler,title:f.title};a.$wrapper.each(function(c,d){var e=jQuery(d),f=e.find(".viewer");0==
f.size()&&(f=e);if(b){var m=TWtid.title_from_wrapper(e),e=m?TWtid.tiddler_section(m)?store.getTiddlerText(m):a.tiddler.text:TWtid.header_content(e.prev(),a);f.empty();wikify(e,f[0]);TWtid.$cur_block=null}config.tableSorting&&config.tableSorting.refresh&&config.tableSorting.refresh(f[0]);TWtid.prepare_wrapper(f,a)});c.scrollLeft(d).scrollTop(e)},pre_go:null,go:function(a,b){var c=jQuery(a).closest("div[id=tiddlerDisplay]");TWtid.wrapper_tiddler(c);var d=config.macros.snapshot.defaultFilename,e=config.options.txtTWtidSnapshotFile;
e?"tiddler.title"==e?e=TWtid.find_tiddler(c).title+".html":-1==e.indexOf(".html")&&(e+=".html"):e=d;c=config.options.chkTWtidSnapshotHideBtn?c.find("a[id^=tedTbtn], a[snapID]"):null;config.macros.snapshot.defaultFilename=e;c&&c.hide();e=TWtid.pre_go.apply(this,arguments);c&&c.show();config.macros.snapshot.defaultFilename=d;return e}};
//}}}
// @@
